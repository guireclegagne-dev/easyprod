<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f0f0;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation; user-select: none;
    }
    .screen { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; color:white; }
    .back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 12px 18px;
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    color: white;
    font-size: 1em;
    font-weight: 500;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.25);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }
    h1 { font-size:2.2em; margin-bottom:30px; font-weight:300; text-align:center; }
    .list { width:100%; max-width:480px; max-height:70vh; overflow:auto; }
    .btn-tile {
      width:100%; padding:20px; margin:10px 0;
      background: rgba(255,255,255,.1); border:2px solid rgba(255,255,255,.3); border-radius:15px; color:white;
      font-size:1.15em; font-weight:500; text-align:center; cursor:pointer; backdrop-filter:blur(10px);
      transition: all .2s ease;
    }
    .btn-tile:hover, .btn-tile.selected { background: rgba(255,255,255,.2); border-color: rgba(255,255,255,.6); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .statusbar { margin-top:8px; text-align:center; font-size:.95em; opacity:.95; }
    @media (max-width: 480px) { .screen { padding:15px; } }
  </style>
  <script src="config.js"></script>
  <script>
    const SUPABASE_URL = CONFIG.SUPABASE.URL;
    const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;

    // Fonctions utilitaires
    const LS = {
      op: 'prod_selected_operator',
      pr: 'prod_selected_project',
      opn: 'prod_selected_operation'
    };
    function setLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function getLS(key) { try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch(e){ return null; } }

    // Variables globales
    let supabaseClient = null;
    const fallback = [
      {id: 1, name: 'Rénovation mobilier bureau', status:'en_cours'},
      {id: 2, name: 'Maintenance préventive', status:'en_cours'},
      {id: 3, name: 'Projet recyclage plastique', status:'terminé'},
      {id: 4, name: 'Formation nouveaux opérateurs', status:'en_cours'},
      {id: 5, name: 'Audit qualité', status:'en_cours'}
    ];

    // Chargement dynamique de Supabase
    function loadAndInitSupabase() {
      return new Promise((resolve, reject) => {
        console.log('Starting Supabase load...');
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
        script.onload = () => {
          console.log('Supabase script loaded');
          
          setTimeout(() => {
            try {
              console.log('Checking window.supabase:', typeof window.supabase);
              
              if (window.supabase && typeof window.supabase.createClient === 'function') {
                console.log('Creating Supabase client...');
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client created successfully');
                resolve(client);
              } else {
                console.error('window.supabase.createClient not available');
                reject(new Error('Supabase createClient not found'));
              }
            } catch(error) {
              console.error('Error creating Supabase client:', error);
              reject(error);
            }
          }, 300);
        };
        
        script.onerror = (error) => {
          console.error('Failed to load Supabase script:', error);
          reject(new Error('Script loading failed'));
        };
        
        document.head.appendChild(script);
      });
    }

    // Fonction principale
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM loaded, initializing...');
      
      // Vérifier qu'un opérateur est sélectionné
      const op = getLS(LS.op); 
      if(!op) {
        location.href='ecran-1-seulement.html';
        return;
      }
      
      // Afficher l'opérateur sélectionné
      document.getElementById('recap').textContent = 'Opérateur: ' + op.name;
      
      try {
        // Charger et initialiser Supabase
        supabaseClient = await loadAndInitSupabase();
        console.log('Supabase ready, fetching projects...');
        
        // Récupérer les projets
        const { data, error } = await supabaseClient
          .from('projects')
          .select('id, name, status')
          .eq('status', 'active')
          .order('name');
        
        if (error) {
          console.error('Supabase query error:', error);
          throw error;
        }
        
        console.log('Projects fetched successfully:', data);
        let items = (data || []).map(p => ({id: p.id, name: p.name}));
        if (!items.length) {
          items = fallback.filter(p => p.status === 'en_cours').map(p => ({id: p.id, name: p.name}));
        }
        render(items);
        
      } catch(error) {
        console.error('Initialization failed, using fallback:', error);
        const items = fallback.filter(p => p.status === 'en_cours').map(p => ({id: p.id, name: p.name}));
        render(items);
      }
    });

    function render(items) {
      console.log('Rendering projects:', items);
      
      document.getElementById('projectsList').innerHTML = items.map(p => `
        <button class="btn-tile" data-id="${p.id}" data-name="${p.name}">
          <i class="fas fa-folder me-3"></i>${p.name}
        </button>
      `).join('');
      
      document.querySelectorAll('.btn-tile').forEach(btn => {
        btn.addEventListener('click', () => {
          const info = { 
            id: Number(btn.dataset.id), 
            name: btn.dataset.name 
          };
          console.log('Project selected:', info);
          setLS(LS.pr, info);
          window.location.href = 'ecran-3-seulement.html';
        });
      });
      
      console.log('Projects rendered successfully');
    }
  </script>
  <title>Sélection projet — Écran 2</title>
</head>
<body>
  <section class="screen" style="background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
    <button class="back-btn" onclick="window.location.href='ecran-1-seulement.html'">
      <i class="fas fa-arrow-left"></i>
      Précédent
    </button>
    <h1><i class="fas fa-project-diagram me-3"></i>Sélectionner un projet</h1>
    <div class="statusbar" id="recap"></div>
    <div class="list" id="projectsList">
      <div class="statusbar"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
    </div>
  </section>
</body>
</html>
