<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordres de Facturation - Reconditionnement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <style>
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        html, body {
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        pre, code:not(.inline-code) {
            display: none !important;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }

        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            text-align: center;
            padding: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .connection-status.connected {
            background: var(--success-color);
            color: white;
        }

        .connection-status.connecting {
            background: var(--warning-color);
            color: white;
        }

        .connection-status.error {
            background: var(--danger-color);
            color: white;
        }

        .navbar {
            background: rgba(44, 62, 80, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 35px;
        }

        .navbar-brand {
            font-size: 1.3em;
            font-weight: bold;
        }

        .main-container {
            padding: 20px;
            margin-top: 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .page-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .content-area {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .section-card h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Contr√¥les de tri */
        .sort-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .sort-controls label {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .sort-controls select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .sort-controls select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        /* Affichage par projet */
        .project-section {
            margin-bottom: 40px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .project-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-title {
            font-size: 1.3em;
            font-weight: bold;
            margin: 0;
        }

        .project-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .project-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .project-content {
            padding: 25px;
            background: white;
        }

        /* Vignettes des commandes */
        .commands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
        }

        .command-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .command-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.2);
            transform: translateY(-3px);
        }

        .command-card.urgent {
            border-left: 5px solid var(--warning-color);
        }

        .command-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .command-ref {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .command-client {
            color: var(--secondary-color);
            font-weight: 500;
            font-size: 0.95em;
        }

        .command-project {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 3px;
        }

        .command-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .amount-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .amount-label {
            font-size: 0.8em;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .amount-value {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .progress-section {
            margin-top: 15px;
        }

        .progress-item {
            margin-bottom: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .progress-label-left {
            font-weight: 600;
            color: var(--primary-color);
        }

        .progress-input {
            width: 60px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 2px 6px;
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
        }

        .progress-input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .progress {
            height: 8px;
            border-radius: 10px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--success-color) 0%, #2ecc71 100%);
            transition: width 0.3s ease;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* Modal de facturation */
        .modal-lg {
            max-width: 800px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-bottom: none;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        .project-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .invoice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .invoice-btn {
            padding: 20px;
            border-radius: 12px;
            border: 2px solid;
            background: white;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }

        .invoice-btn.advancement {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        .invoice-btn.advancement:hover {
            background: var(--secondary-color);
            color: white;
        }

        .invoice-btn.final {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .invoice-btn.final:hover {
            background: var(--success-color);
            color: white;
        }

        .invoice-btn i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .history-section {
            margin-top: 30px;
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .history-content {
            flex-grow: 1;
        }

        .history-type {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .history-date {
            font-size: 0.85em;
            color: #6c757d;
        }

        .history-user {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .commands-grid {
                grid-template-columns: 1fr;
            }

            .command-amounts {
                grid-template-columns: 1fr;
            }

            .invoice-buttons {
                grid-template-columns: 1fr;
            }

            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
        }
        /* Dans le fichier ordres-facturation.html, ajoutez le CSS am√©lior√© juste avant la fermeture de la balise </style> */

       
    </style>
</head>
<body>
    <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-spinner fa-spin me-1"></i> Connexion...
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="console-admin-standalone.html">
                <i class="fas fa-arrow-left me-2"></i>
                <i class="fas fa-file-invoice-dollar me-2"></i>
                Ordres de Facturation
            </a>
            <div class="navbar-nav ms-auto">
                <a href="console-admin-standalone.html" class="btn btn-outline-light me-3">
                    <i class="fas fa-arrow-left me-2"></i>Retour Console
                </a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
                <span class="navbar-text me-3">
                    <i class="fas fa-user-shield me-1"></i>
                    Manager
                </span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1><i class="fas fa-file-invoice-dollar me-3"></i>Ordres de Facturation</h1>
            <p class="mb-0">G√©rez les ordres de facturation des commandes en cours</p>
        </div>

        <div class="content-area">
            <!-- Contr√¥les de tri -->
            <div class="section-card">
                <div class="sort-controls">
                    <div>
                        <label>Afficher :</label>
                        <select id="statusFilter" onchange="filterCommands()">
                            <option value="tous">Tous les projets</option>
                            <option value="actif">Projets actifs seulement</option>
                            <option value="non-actif">Projets non-actifs seulement</option>
                        </select>
                    </div>
                    <div>
                        <label>Trier par :</label>
                        <select id="sortBy" onchange="sortCommands()">
                            <option value="date_desc">Date (plus r√©cent)</option>
                            <option value="date_asc">Date (plus ancien)</option>
                            <option value="realisation_desc">R√©alisation (plus avanc√©)</option>
                            <option value="realisation_asc">R√©alisation (moins avanc√©)</option>
                            <option value="montant_desc">Montant (plus √©lev√©)</option>
                            <option value="montant_asc">Montant (moins √©lev√©)</option>
                        </select>
                    </div>
                    <div class="ms-auto">
                        <button class="btn btn-outline-primary" onclick="refreshCommands()">
                            <i class="fas fa-sync me-2"></i>Actualiser
                        </button>
                    </div>
                </div>
            </div>

            <!-- Commandes -->
            <div class="section-card">
                <h4><i class="fas fa-list me-2"></i>Commandes en Cours</h4>
                
                <div id="commandsContainer">
                    <div class="text-center py-5">
                        <div class="loading-spinner me-3"></div>
                        <span>Chargement des commandes...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Commandes du Projet -->
    <div class="modal fade" id="projectModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-project-diagram me-2"></i>
                        <span id="modalProjectName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="project-stats mb-4 d-flex gap-4 justify-content-center">
                        <div class="project-stat bg-light p-3 rounded">
                            <i class="fas fa-file-alt text-primary me-2"></i>
                            <span id="modalProjectCommands">0 commande</span>
                        </div>
                        <div class="project-stat bg-light p-3 rounded">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            <span id="modalProjectRealization">0% r√©alis√©</span>
                        </div>
                        <div class="project-stat bg-light p-3 rounded">
                            <i class="fas fa-file-invoice text-warning me-2"></i>
                            <span id="modalProjectInvoiced">0% factur√©</span>
                        </div>
                    </div>
                    
                    <div id="modalCommandsGrid" class="commands-grid">
                        <!-- Les commandes du projet seront affich√©es ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ordre de Facturation -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-invoice me-2"></i>
                        Ordre de Facturation - <span id="modalCommandRef"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Informations commande -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">D√©tails de la commande</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Client :</strong> <span id="modalClient"></span><br>
                                <strong>Projet :</strong> <span id="modalProject"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>R√©alisation :</strong> <span id="modalRealisation"></span>%<br>
                                <strong>D√©j√† factur√© :</strong> <span id="modalFacture"></span>%
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="invoice-buttons">
                        <div class="invoice-btn advancement" onclick="sendInvoiceOrder('avancement')">
                            <i class="fas fa-chart-line"></i>
                            <div>Facturer l'avancement</div>
                            <small class="text-muted mt-2">Envoie un ordre de facturation √† l'ADV pour l'avancement r√©alis√©</small>
                        </div>
                        <div class="invoice-btn final" onclick="sendInvoiceOrder('solde')">
                            <i class="fas fa-check-circle"></i>
                            <div>Facturer le solde</div>
                            <small class="text-muted mt-2">Envoie un ordre de facturation √† l'ADV pour le solde final</small>
                        </div>
                    </div>

                    <!-- Historique -->
                    <div class="history-section">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-history me-2"></i>Historique des ordres
                        </h6>
                        <div id="invoiceHistory">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-clock me-2"></i>Aucun ordre de facturation envoy√©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let supabase = null;
        let supabaseLoaded = false;
        let commands = [];
        let currentCommand = null;
        let filteredCommands = [];
        let projectsData = {};

        // Configuration Supabase
        const SUPABASE_URL = CONFIG.SUPABASE.URL;
const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupabase();
        });

        function initializeSupabase() {
            try {
                updateConnectionStatus('connecting', 'Connexion en cours...');
                
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    supabaseLoaded = true;
                    updateConnectionStatus('connected', 'Connect√© √† Supabase');
                    loadCommands();
                } else {
                    throw new Error('Supabase non disponible');
                }
            } catch (error) {
                console.error('Erreur Supabase:', error);
                updateConnectionStatus('error', 'Mode hors-ligne');
                loadSampleCommands();
            }
        }

        async function loadCommands() {
    try {
        if (!supabaseLoaded) {
            loadSampleCommands();
            return;
        }

        const { data, error } = await supabase
            .from('commandes_odoo')
            .select(`
                *,
                projects:project_id (
                    id,
                    name,
                    status
                )
            `)
            .not('project_id', 'is', null)
            .neq('etat_facture', 'CL√îTUR√â')
            .order('date_commande', { ascending: false });

        if (error) {
            if (error.message.includes('avancement_realise')) {
                showCreateColumnsMessage();
                return;
            }
            throw error;
        }

        commands = data || [];
        
        // NOUVEAU : Calculer les avancements r√©els pour chaque commande
        for (let command of commands) {
            if (command.project_id) {
                const progress = await calculateRealProgress(command.project_id);
                // Utiliser l'avancement r√©alis√© comme r√©f√©rence principale
                command.avancement_realise = progress.avancementRealise;
                command.avancement_operationnel = progress.avancementOperationnel;
            }
        }
        
        console.log('Commandes charg√©es avec avancements calcul√©s:', commands);
        
        organizeByProject();
        displayCommands();

    } catch (error) {
        console.error('Erreur chargement commandes:', error);
        showToast('Erreur lors du chargement des commandes: ' + error.message, 'danger');
        loadSampleCommands();
    }
}

        function organizeByProject() {
            projectsData = {};
            
            commands.forEach(command => {
                const projectId = command.project_id;
                const projectName = command.projects?.name || 'Projet non d√©fini';
                
                if (!projectsData[projectId]) {
                    projectsData[projectId] = {
                        name: projectName,
                        commands: [],
                        totalCommands: 0,
                        averageRealization: 0,
                        averageInvoiced: 0,
                        isActive: false
                    };
                }
                
                projectsData[projectId].commands.push(command);
            });
            
            // Calculer les statistiques de chaque projet
            Object.keys(projectsData).forEach(projectId => {
                const project = projectsData[projectId];
                project.totalCommands = project.commands.length;
                
                const totalRealization = project.commands.reduce((sum, cmd) => sum + (cmd.avancement_realise || 0), 0);
                const totalInvoiced = project.commands.reduce((sum, cmd) => sum + (cmd.avancement_facture || 0), 0);
                
                project.averageRealization = project.totalCommands > 0 ? Math.round(totalRealization / project.totalCommands) : 0;
                project.averageInvoiced = project.totalCommands > 0 ? Math.round(totalInvoiced / project.totalCommands) : 0;
                
                // Un projet est actif si au moins une commande a un avancement < 100%
                project.isActive = project.commands[0]?.projects?.status === 'active';
            });
        }
        async function calculateRealProgress(projectId) {
    try {
        const { data: projectConfig, error: configError } = await supabase
            .from('project_details')
            .select('selected_operations, nombre_sieges')
            .eq('project_id', parseInt(projectId))
            .single();

        if (configError || !projectConfig || !projectConfig.selected_operations) {
            return { avancementRealise: 0, avancementOperationnel: 0 };
        }

        const selectedOperationIds = JSON.parse(projectConfig.selected_operations);
        
        if (!Array.isArray(selectedOperationIds) || selectedOperationIds.length === 0) {
            return { avancementRealise: 0, avancementOperationnel: 0 };
        }

        // R√©cup√©rer les op√©rations
        const { data: operationsData, error: opsError } = await supabase
            .from('operations')
            .select('*')
            .in('id', selectedOperationIds);

        if (opsError || !operationsData) {
            return { avancementRealise: 0, avancementOperationnel: 0 };
        }

        // R√©cup√©rer les t√¢ches r√©alis√©es
        const { data: tasks, error: tasksError } = await supabase
            .from('tasks')
            .select('operation_id, quantity')
            .eq('project_id', parseInt(projectId));

        // Calculer les quantit√©s r√©alis√©es par op√©ration
        const realizedByOperation = {};
        if (tasks && !tasksError) {
            tasks.forEach(task => {
                if (!realizedByOperation[task.operation_id]) {
                    realizedByOperation[task.operation_id] = 0;
                }
                realizedByOperation[task.operation_id] += task.quantity || 0;
            });
        }

        const totalSeats = projectConfig.nombre_sieges || 100;
        let totalOperationsToRealize = 0;
        let totalOperationsRealized = 0;
        let emballedSeats = 0;

        operationsData.forEach(op => {
            const toRealize = totalSeats;
            const realized = realizedByOperation[op.id] || 0;
            
            totalOperationsToRealize += toRealize;
            totalOperationsRealized += realized;
            
            // Identifier l'op√©ration "emballage"
            if (op.name && op.name.toLowerCase().includes('emballage')) {
                emballedSeats = realized;
            }
        });

        // Fallback si pas d'emballage
        if (emballedSeats === 0 && operationsData.length > 0) {
            const realizedCounts = operationsData.map(op => realizedByOperation[op.id] || 0);
            emballedSeats = Math.min(...realizedCounts);
        }

        const avancementRealise = totalSeats > 0 ? 
            Math.round((emballedSeats / totalSeats) * 100) : 0;
        
        const avancementOperationnel = totalOperationsToRealize > 0 ? 
            Math.round((totalOperationsRealized / totalOperationsToRealize) * 100) : 0;

        return { avancementRealise, avancementOperationnel };

    } catch (error) {
        console.error('Erreur calcul avancement:', error);
        return { avancementRealise: 0, avancementOperationnel: 0 };
    }
}
        function loadSampleCommands() {
            // Donn√©es d'exemple pour le mode hors-ligne
            commands = [
                {
                    id: 1,
                    reference: 'S00001',
                    client: 'ACME Corp',
                    project_id: 1,
                    projects: { name: 'R√©novation Bureau Ouest' },
                    prix_vente_prestation: 15000,
                    prix_vente_logistique: 2500,
                    prix_vente_autre: 500,
                    avancement_realise: 75,
                    avancement_facture: 50,
                    date_commande: '2024-01-15'
                },
                {
                    id: 2,
                    reference: 'S00002',
                    client: 'TechStart SARL',
                    project_id: 2,
                    projects: { name: 'Am√©nagement Open Space' },
                    prix_vente_prestation: 8500,
                    prix_vente_logistique: 1200,
                    prix_vente_autre: 300,
                    avancement_realise: 45,
                    avancement_facture: 25,
                    date_commande: '2024-01-12'
                },
                {
                    id: 3,
                    reference: 'S00003',
                    client: 'Global Industries',
                    project_id: 1,
                    projects: { name: 'R√©novation Bureau Ouest' },
                    prix_vente_prestation: 12000,
                    prix_vente_logistique: 1800,
                    prix_vente_autre: 200,
                    avancement_realise: 90,
                    avancement_facture: 75,
                    date_commande: '2024-01-10'
                }
            ];
            
            organizeByProject();
            displayCommands();
        }

        function displayCommands() {
            const container = document.getElementById('commandsContainer');
            
            if (Object.keys(projectsData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <h3>Aucune commande en cours</h3>
                        <p>Aucune commande n'est disponible pour facturation</p>
                    </div>
                `;
                return;
            }

            const statusFilter = document.getElementById('statusFilter')?.value || 'tous';
            let projectsToShow = Object.keys(projectsData);

            // Filtrer selon le statut
            if (statusFilter === 'actif') {
                projectsToShow = projectsToShow.filter(projectId => projectsData[projectId].isActive);
            } else if (statusFilter === 'non-actif') {
                projectsToShow = projectsToShow.filter(projectId => !projectsData[projectId].isActive);
            }

            if (projectsToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-filter"></i>
                        <h3>Aucun projet trouv√©</h3>
                        <p>Aucun projet ne correspond aux crit√®res de filtrage s√©lectionn√©s</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = projectsToShow.map(projectId => {
                const project = projectsData[projectId];
                const statusClass = project.isActive ? 'success' : 'secondary';
                const statusIcon = project.isActive ? 'play-circle' : 'pause-circle';
                const statusText = project.isActive ? 'Actif' : 'Inactif';
                return `
                    <div class="project-section">
                        <div class="project-header" onclick="openProjectModal('${projectId}')">
                            <div>
                                <h3 class="project-title">
                                    <i class="fas fa-project-diagram me-2"></i>
                                    ${project.name}
                                </h3>
                            </div>
                            <div class="project-stats">
                                <div class="project-stat">
                                    <i class="fas fa-${statusIcon}"></i>
                                    ${statusText}
                                </div>
                                <div class="project-stat">
                                    <i class="fas fa-file-alt"></i>
                                    ${project.totalCommands} commande${project.totalCommands > 1 ? 's' : ''}
                                </div>
                                <div class="project-stat">
                                    <i class="fas fa-chart-line"></i>
                                    ${project.averageRealization}% r√©alis√©
                                </div>
                                <div class="project-stat">
                                    <i class="fas fa-file-invoice"></i>
                                    ${project.averageInvoiced}% factur√©
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createCommandCard(command) {
    const clientName = command.client || 'Client inconnu';
    const prestation = parseFloat(command.prix_vente_prestation || 0);
    const logistique = parseFloat(command.prix_vente_logistique || 0);
    const autre = parseFloat(command.prix_vente_autre || 0);
    const realisationPct = parseFloat(command.avancement_realise || 0);
    const facturePct = parseFloat(command.avancement_facture || 0);
    
    const isUrgent = realisationPct >= 80 && facturePct < 70;

    return `
        <div class="command-card ${isUrgent ? 'urgent' : ''}" data-command-id="${command.id}">
            <div class="command-header">
                <div>
                    <div class="command-ref">${command.reference}</div>
                    <div class="command-client">${clientName}</div>
                    <div class="command-project">${command.projects?.name || 'Projet non d√©fini'}</div>
                </div>
                <div class="command-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="openInvoiceModal(${command.id})" title="Ordre de facturation">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                </div>
            </div>

            <div class="command-amounts">
                <div class="amount-item">
                    <div class="amount-label">Prestation</div>
                    <div class="amount-value">${prestation.toLocaleString()}‚Ç¨</div>
                </div>
                <div class="amount-item">
                    <div class="amount-label">Logistique</div>
                    <div class="amount-value">${logistique.toLocaleString()}‚Ç¨</div>
                </div>
                <div class="amount-item">
                    <div class="amount-label">Autre</div>
                    <div class="amount-value">${autre.toLocaleString()}‚Ç¨</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-label">
                        <span class="progress-label-left">Saisir la r√©alisation √† facturer</span>
                        <div class="progress-input-group">
                            <input type="number" 
                                   class="progress-input" 
                                   value="${realisationPct}" 
                                   min="0" 
                                   max="100" 
                                   step="1"
                                   id="realisation-${command.id}"
                                   onchange="updateRealizationFromCard(${command.id}, this.value)"
                                   onclick="event.stopPropagation()"
                                   onkeydown="handleRealizationKeydown(event, ${command.id})"
                                   title="Cliquez pour modifier le taux de r√©alisation">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="progress" onclick="setRealizationFromProgressBar(event, ${command.id})">
                        <div class="progress-bar" style="width: ${realisationPct}%"></div>
                    </div>
                </div>
                
                <div class="progress-item">
                    <div class="progress-label">
                        <span class="progress-label-left">Factur√©</span>
                        <span>${facturePct}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: ${facturePct}%"></div>
                    </div>
                </div>
            </div>

            <!-- Indicateur de modification r√©cente -->
            <div class="update-indicator" id="update-indicator-${command.id}" style="display: none;">
                <i class="fas fa-check-circle text-success"></i>
                <span>Mis √† jour</span>
            </div>
        </div>
    `;
}

// Fonction am√©lior√©e pour mettre √† jour depuis la card
async function updateRealizationFromCard(commandId, newValue) {
    const value = Math.min(Math.max(parseFloat(newValue) || 0, 0), 100);
    
    // Mettre √† jour visuellement le champ si la valeur a √©t√© corrig√©e
    const input = document.getElementById(`realisation-${commandId}`);
    if (input) {
        input.value = value;
    }
    
    try {
        if (supabaseLoaded) {
            const { error } = await supabase
                .from('commandes_odoo')
                .update({ avancement_realise: value })
                .eq('id', commandId);

            if (error) throw error;
        }

        // Mettre √† jour localement
        const command = commands.find(cmd => cmd.id === commandId);
        if (command) {
            command.avancement_realise = value;
        }

        // Mettre √† jour la barre de progression
        const progressBar = input?.closest('.progress-item')?.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.width = `${value}%`;
        }

        // Afficher l'indicateur de mise √† jour
        showUpdateIndicator(commandId);

        // R√©organiser les donn√©es et rafra√Æchir l'affichage des statistiques du projet
        organizeByProject();
        updateProjectStats();
        
    } catch (error) {
        console.error('Erreur mise √† jour avancement:', error);
        showToast('Erreur lors de la mise √† jour: ' + error.message, 'danger');
        
        // Restaurer la valeur pr√©c√©dente en cas d'erreur
        if (input) {
            const command = commands.find(cmd => cmd.id === commandId);
            input.value = command?.avancement_realise || 0;
        }
    }
}

// G√©rer les touches sp√©ciales dans le champ de saisie
function handleRealizationKeydown(event, commandId) {
    // Valider avec Entr√©e
    if (event.key === 'Enter') {
        event.target.blur();
        updateRealizationFromCard(commandId, event.target.value);
    }
    
    // Annuler avec √âchap
    if (event.key === 'Escape') {
        const command = commands.find(cmd => cmd.id === commandId);
        event.target.value = command?.avancement_realise || 0;
        event.target.blur();
    }
    
    // Permettre seulement les chiffres, backspace, delete, tab, fl√®ches
    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Enter', 'Escape'];
    if (!allowedKeys.includes(event.key) && !/^[0-9]$/.test(event.key)) {
        event.preventDefault();
    }
}

// Permettre de cliquer sur la barre de progression pour d√©finir la valeur
function setRealizationFromProgressBar(event, commandId) {
    event.stopPropagation();
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = Math.round((clickX / rect.width) * 100);
    const value = Math.min(Math.max(percentage, 0), 100);
    
    updateRealizationFromCard(commandId, value);
}

// Afficher un indicateur visuel de mise √† jour
function showUpdateIndicator(commandId) {
    const indicator = document.getElementById(`update-indicator-${commandId}`);
    if (indicator) {
        indicator.style.display = 'flex';
        indicator.style.animation = 'fadeIn 0.3s ease';
        
        setTimeout(() => {
            indicator.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 300);
        }, 2000);
    }
}

// Mettre √† jour les statistiques du projet dans la modal
function updateProjectStats() {
    // Si une modal de projet est ouverte, mettre √† jour ses statistiques
    const modalElement = document.getElementById('projectModal');
    if (modalElement && modalElement.classList.contains('show')) {
        // Recalculer les stats et les afficher
        Object.keys(projectsData).forEach(projectId => {
            const project = projectsData[projectId];
            const totalRealization = project.commands.reduce((sum, cmd) => sum + (cmd.avancement_realise || 0), 0);
            const totalInvoiced = project.commands.reduce((sum, cmd) => sum + (cmd.avancement_facture || 0), 0);
            
            project.averageRealization = project.totalCommands > 0 ? Math.round(totalRealization / project.totalCommands) : 0;
            project.averageInvoiced = project.totalCommands > 0 ? Math.round(totalInvoiced / project.totalCommands) : 0;
        });
    }
}
        async function updateRealization(commandId, newValue) {
            const value = Math.min(Math.max(parseFloat(newValue) || 0, 0), 100);
            
            try {
                if (supabaseLoaded) {
                    const { error } = await supabase
                        .from('commandes_odoo')
                        .update({ avancement_realise: value })
                        .eq('id', commandId);

                    if (error) throw error;
                }

                // Mettre √† jour localement
                const command = commands.find(cmd => cmd.id === commandId);
                if (command) {
                    command.avancement_realise = value;
                }

                // R√©organiser les donn√©es et rafra√Æchir l'affichage
                organizeByProject();
                displayCommands();
                
                showToast('Avancement mis √† jour', 'success', 2000);

            } catch (error) {
                console.error('Erreur mise √† jour avancement:', error);
                showToast('Erreur lors de la mise √† jour: ' + error.message, 'danger');
            }
        }

        function openProjectModal(projectId) {
            const project = projectsData[projectId];
            if (!project) return;

            // Remplir les informations de la modal
            document.getElementById('modalProjectName').textContent = project.name;
            document.getElementById('modalProjectCommands').textContent = `${project.totalCommands} commande${project.totalCommands > 1 ? 's' : ''}`;
            document.getElementById('modalProjectRealization').textContent = `${project.averageRealization}% r√©alis√©`;
            document.getElementById('modalProjectInvoiced').textContent = `${project.averageInvoiced}% factur√©`;

            // Afficher les commandes du projet
            const commandsGrid = document.getElementById('modalCommandsGrid');
            commandsGrid.innerHTML = project.commands.map(command => createCommandCard(command)).join('');

            // Ouvrir la modal
            new bootstrap.Modal(document.getElementById('projectModal')).show();
        }

        function openInvoiceModal(commandId) {
            currentCommand = commands.find(cmd => cmd.id === commandId);
            if (!currentCommand) return;

            // Remplir les informations de la modal
            document.getElementById('modalCommandRef').textContent = currentCommand.reference;
            document.getElementById('modalClient').textContent = currentCommand.revendeurs?.raison_sociale || currentCommand.client || 'Client inconnu';
            document.getElementById('modalProject').textContent = currentCommand.projects?.name || 'Projet non d√©fini';
            document.getElementById('modalRealisation').textContent = currentCommand.avancement_realise || 0;
            document.getElementById('modalFacture').textContent = currentCommand.avancement_facture || 0;

            // Charger l'historique
            loadInvoiceHistory(commandId);

            // Ouvrir la modal
            new bootstrap.Modal(document.getElementById('invoiceModal')).show();
        }

        async function loadInvoiceHistory(commandId) {
            const historyContainer = document.getElementById('invoiceHistory');
            
            try {
                if (!supabaseLoaded) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-wifi-slash me-2"></i>Historique non disponible (mode hors-ligne)
                        </div>
                    `;
                    return;
                }

                const { data, error } = await supabase
                    .from('ordres_facturation')
                    .select('*')
                    .eq('commande_id', commandId)
                    .order('date_envoi', { ascending: false });

                if (error && !error.message.includes('does not exist')) {
                    throw error;
                }

                const history = data || [];

                if (history.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-clock me-2"></i>Aucun ordre de facturation envoy√©
                        </div>
                    `;
                    return;
                }

                historyContainer.innerHTML = history.map(item => `
                    <div class="history-item">
                        <div class="history-icon">
                            <i class="fas fa-${item.type_ordre === 'avancement' ? 'chart-line' : 'check-circle'}"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-type">
                                ${item.type_ordre === 'avancement' ? 'Ordre Avancement' : 'Ordre Solde'}
                            </div>
                            <div class="history-date">
                                ${new Date(item.date_envoi).toLocaleDateString('fr-FR', {
                                    day: 'numeric',
                                    month: 'long',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                            <span class="history-user">${item.utilisateur || 'Manager'}</span>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erreur chargement historique:', error);
                historyContainer.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Erreur chargement historique
                    </div>
                `;
            }
        }

        async function sendInvoiceOrder(type) {
            if (!currentCommand) return;

            const typeLabel = type === 'avancement' ? 'avancement' : 'solde';
            const confirmed = confirm(`Confirmer l'envoi de l'ordre de facturation ${typeLabel} √† l'Administration Des Ventes ?\n\nCommande: ${currentCommand.reference}\nClient: ${currentCommand.revendeurs?.raison_sociale || currentCommand.client}`);
            
            if (!confirmed) return;

            try {
                let newFacturePct = currentCommand.avancement_facture || 0;
                
                if (type === 'avancement') {
                    // Facturer l'avancement : mettre avancement_facture au niveau de avancement_realise
                    newFacturePct = currentCommand.avancement_realise || 0;
                } else if (type === 'solde') {
                    // Facturer le solde : mettre avancement_facture √† 100%
                    newFacturePct = 100;
                }

                if (supabaseLoaded) {
                    // Mettre √† jour l'avancement factur√©
                    const { error: updateError } = await supabase
                        .from('commandes_odoo')
                        .update({ avancement_facture: newFacturePct })
                        .eq('id', currentCommand.id);

                    if (updateError) throw updateError;

                    // Enregistrer l'ordre dans l'historique
                    const { error: historyError } = await supabase
                        .from('ordres_facturation')
                        .insert({
                            commande_id: currentCommand.id,
                            type_ordre: type,
                            date_envoi: new Date().toISOString(),
                            utilisateur: 'Manager',
                            statut: 'envoy√©'
                        });

                    if (historyError && !historyError.message.includes('does not exist')) {
                        console.warn('Erreur enregistrement historique:', historyError);
                        showCreateHistoryTableMessage();
                    }
                }

                // Mettre √† jour localement
                currentCommand.avancement_facture = newFacturePct;

                // Simuler l'envoi d'email (ici vous int√©greriez votre syst√®me d'email)
                await simulateEmailSend(type, currentCommand);

                // Fermer la modal
                bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();

                // R√©organiser les donn√©es et rafra√Æchir l'affichage
                organizeByProject();
                displayCommands();

                showToast(`Ordre de facturation ${typeLabel} envoy√© avec succ√®s !`, 'success');

            } catch (error) {
                console.error('Erreur envoi ordre:', error);
                showToast('Erreur lors de l\'envoi: ' + error.message, 'danger');
            }
        }

        async function simulateEmailSend(type, command) {
            // Simulation d'envoi d'email - remplacez par votre API d'email
            const emailData = {
                to: 'administration-ventes@entreprise.com', // √Ä param√©trer
                subject: `Ordre de facturation ${type} - ${command.reference}`,
                body: type === 'avancement' 
                    ? `Bonjour,\n\nMerci de proc√©der √† la facturation d'avancement pour la commande ${command.reference}.\n\nClient: ${command.revendeurs?.raison_sociale || command.client}\nAvancement r√©alis√©: ${command.avancement_realise}%\n\nCordialement,\nL'√©quipe Production`
                    : `Bonjour,\n\nMerci de proc√©der √† la facturation du solde pour la commande ${command.reference}.\n\nClient: ${command.revendeurs?.raison_sociale || command.client}\nFacturation finale (100%)\n\nCordialement,\nL'√©quipe Production`
            };

            console.log('Email simul√©:', emailData);
            
            // Simulation d'un d√©lai d'envoi
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        function filterCommands() {
            displayCommands();
        }

        function sortCommands() {
            const sortBy = document.getElementById('sortBy').value;
            
            // Trier les commandes dans chaque projet
            Object.keys(projectsData).forEach(projectId => {
                const project = projectsData[projectId];
                
                project.commands.sort((a, b) => {
                    switch (sortBy) {
                        case 'date_desc':
                            return new Date(b.date_commande) - new Date(a.date_commande);
                        case 'date_asc':
                            return new Date(a.date_commande) - new Date(b.date_commande);
                        case 'realisation_desc':
                            return (b.avancement_realise || 0) - (a.avancement_realise || 0);
                        case 'realisation_asc':
                            return (a.avancement_realise || 0) - (b.avancement_realise || 0);
                        case 'montant_desc':
                            const totalB = (b.prix_vente_prestation || 0) + (b.prix_vente_logistique || 0) + (b.prix_vente_autre || 0);
                            const totalA = (a.prix_vente_prestation || 0) + (a.prix_vente_logistique || 0) + (a.prix_vente_autre || 0);
                            return totalB - totalA;
                        case 'montant_asc':
                            const totalA2 = (a.prix_vente_prestation || 0) + (a.prix_vente_logistique || 0) + (a.prix_vente_autre || 0);
                            const totalB2 = (b.prix_vente_prestation || 0) + (b.prix_vente_logistique || 0) + (b.prix_vente_autre || 0);
                            return totalA2 - totalB2;
                        default:
                            return 0;
                    }
                });
            });
            
            displayCommands();
        }

        function refreshCommands() {
            const button = event.target;
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualisation...';
            button.disabled = true;

            setTimeout(() => {
                loadCommands();
                button.innerHTML = originalIcon;
                button.disabled = false;
                showToast('Commandes actualis√©es', 'success', 2000);
            }, 1000);
        }

        function showCreateColumnsMessage() {
            showToast(`
                Colonnes manquantes dans la table commandes_odoo.<br>
                Ajoutez-les avec ce SQL :<br><br>
                <code style="background: #f8f9fa; padding: 10px; border-radius: 5px; display: block;">
                ALTER TABLE commandes_odoo ADD COLUMN IF NOT EXISTS avancement_realise DECIMAL(5,2) DEFAULT 0;<br>
                ALTER TABLE commandes_odoo ADD COLUMN IF NOT EXISTS avancement_facture DECIMAL(5,2) DEFAULT 0;
                </code>
            `, 'warning', 15000);
        }

        function showCreateHistoryTableMessage() {
            showToast(`
                Table 'ordres_facturation' manquante.<br>
                Cr√©ez-la avec ce SQL :<br><br>
                <code style="background: #f8f9fa; padding: 10px; border-radius: 5px; display: block;">
                CREATE TABLE IF NOT EXISTS ordres_facturation (<br>
                &nbsp;&nbsp;id SERIAL PRIMARY KEY,<br>
                &nbsp;&nbsp;commande_id INTEGER REFERENCES commandes_odoo(id),<br>
                &nbsp;&nbsp;type_ordre VARCHAR(20) NOT NULL CHECK (type_ordre IN ('avancement', 'solde')),<br>
                &nbsp;&nbsp;date_envoi TIMESTAMP DEFAULT now(),<br>
                &nbsp;&nbsp;utilisateur VARCHAR(100),<br>
                &nbsp;&nbsp;statut VARCHAR(20) DEFAULT 'envoy√©',<br>
                &nbsp;&nbsp;created_at TIMESTAMP DEFAULT now()<br>
                );<br><br>
                ALTER TABLE ordres_facturation ENABLE ROW LEVEL SECURITY;<br>
                CREATE POLICY "Allow all operations on ordres_facturation" ON ordres_facturation FOR ALL USING (true);
                </code>
            `, 'warning', 15000);
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.innerHTML = `<i class="fas fa-${status === 'connected' ? 'check' : status === 'connecting' ? 'spinner fa-spin' : 'exclamation-triangle'} me-1"></i> ${message}`;
        }

        function showToast(message, type = 'info', duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;';
            toast.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Suppression automatique
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, duration);
        }

        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                window.location.href = 'console-admin-standalone.html';
            }
        }
    </script>
</body>
</html>