<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f0f0;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation; user-select: none;
    }
    .screen { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; color:white; }
    h1 { font-size:2.2em; margin-bottom:30px; font-weight:300; text-align:center; }
    .card { width:min(640px,95vw); padding:22px; border-radius:16px; background: rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.25); backdrop-filter: blur(10px); box-shadow:0 8px 25px rgba(0,0,0,.2); }
    .row { display:flex; align-items:center; gap:10px; margin:8px 0; font-size:1.05em; }
    .row i { width:24px; text-align:center; opacity:.95; }
    .controls { margin-top:18px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .btn { padding:14px 22px; font-size:1.05em; font-weight:600; border-radius:14px; border:none; cursor:pointer; transition: all 0.2s ease; }
    .btn-white { background:#fff; color:#1f2937; }
    .btn-white:hover { background:#f3f4f6; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .statusbar { margin-top:8px; text-align:center; font-size:.95em; opacity:.95; }
    @media (max-width: 480px) { .screen { padding:15px; } .card { padding:18px; } }
  </style>
 <script src="config.js"></script>
  <script>
  const SUPABASE_URL = CONFIG.SUPABASE.URL;
  const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;
    const LS = {
      op: 'prod_selected_operator',
      pr: 'prod_selected_project',
      opn: 'prod_selected_operation',
      start: 'prod_started_at',
      end: 'prod_ended_at',
      exec: 'prod_execution_ms',
      pause: 'prod_pause_ms',
      taskId: 'current_task_id'
    };
    function setLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function getLS(key) { try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch(e){ return null; } }
  </script>

<title>Prêt à démarrer — Écran 4</title>
</head>
<body>
  <section class="screen" style="background: linear-gradient(135deg,#11998e 0%,#38ef7d 100%);">
    <h1><i class="fas fa-rocket me-3"></i>Prêt à démarrer</h1>
    <div class="card">
      <div class="row"><i class="fas fa-user"></i> <span id="rOp">—</span></div>
      <div class="row"><i class="fas fa-folder"></i> <span id="rProj">—</span></div>
      <div class="row"><i class="fas fa-cog"></i> <span id="rOpn">—</span></div>
      <div class="controls">
        <button class="btn btn-white" id="startBtn">Démarrer</button>
      </div>
      <div class="statusbar" id="dbStatus"></div>
    </div>
  </section>

<script>
let supabase = null;

document.addEventListener('DOMContentLoaded', ()=>{
  const op = getLS(LS.op), pr=getLS(LS.pr), opn=getLS(LS.opn);
  if(!op) return location.href='ecran-1-seulement.html';
  if(!pr) return location.href='ecran-2-seulement.html';
  if(!opn) return location.href='ecran-3-seulement.html';
  
  document.getElementById('rOp').textContent = op.name;
  document.getElementById('rProj').textContent = pr.name;
  document.getElementById('rOpn').textContent = opn.name;
  
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  document.getElementById('startBtn').addEventListener('click', async ()=>{
    await startTask();
  });
});

async function startTask() {
  const startBtn = document.getElementById('startBtn');
  const dbStatus = document.getElementById('dbStatus');
  
  startBtn.disabled = true;
  dbStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création de la tâche...';
  
  const now = new Date().toISOString();
  setLS(LS.start, now);
  
  // Collecter toutes les données
  const op = getLS(LS.op);
  const pr = getLS(LS.pr);
  const opn = getLS(LS.opn);
  
  try {
    // Insertion complète en une fois
    const payload = {
      operator_id: String(op.id),
      operator_name: op.name,
      project_id: pr.id,
      project_name: pr.name,
      operation_id: opn.id,
      operation_name: opn.name,
      started_at: now,
      status: 'in_progress',
      pause_ms: 0
    };
    
    const { data, error } = await supabase
      .from('tasks')
      .insert(payload)
      .select('id')
      .single();
    
    if (error) throw error;
    
    // Stocker l'ID pour les écrans suivants
    setLS(LS.taskId, data.id);
    
    dbStatus.innerHTML = 'Tâche créée avec succès';
    
    // Reset des données de timing précédentes
    localStorage.removeItem(LS.end); 
    localStorage.removeItem(LS.exec); 
    localStorage.removeItem(LS.pause);
    
    setTimeout(() => {
      window.location.href = 'ecran-5-seulement.html';
    }, 800);
    
  } catch(e) {
    console.error('Erreur création tâche complète:', e);
    dbStatus.innerHTML = 'Erreur: ' + (e.message || 'Impossible de créer la tâche');
    startBtn.disabled = false;
    
    // Proposer de continuer en mode offline après 3 secondes
    setTimeout(() => {
      dbStatus.innerHTML = 'Mode offline - Cliquez pour continuer';
      startBtn.disabled = false;
      startBtn.onclick = () => {
        // En mode offline, pas de taskId
        localStorage.removeItem(LS.taskId);
        window.location.href = 'ecran-5-seulement.html';
      };
    }, 3000);
  }
}
</script>
</body>
</html>