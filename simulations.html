<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulations - EasyProd by Luceleanne</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: var(--primary-color) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .main-container {
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .simulation-tabs {
            padding: 0;
            margin: 0;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .simulation-tabs .nav-link {
            border: none;
            border-radius: 0;
            padding: 20px 30px;
            color: var(--primary-color);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .simulation-tabs .nav-link.active {
            background: white;
            color: var(--secondary-color);
            border-bottom: 3px solid var(--secondary-color);
        }

        .simulation-tabs .nav-link:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .tab-content {
            padding: 30px;
        }

        .simulation-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: 600;
        }

        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            border-radius: 8px;
            padding: 12px 25px;
            font-weight: 600;
        }

        .results-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--info-color);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .neutral { color: var(--info-color); }

        .operation-row {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
        }

        .operations-panel {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 10px;
        }

        .operation-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .operation-item:hover {
            background: #e3f2fd;
            border-color: var(--secondary-color);
        }

        .operation-item.selected {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .category-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .planning-timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline-item {
            position: relative;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--secondary-color);
        }

        .planning-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hidden { display: none; }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .simulation-tabs .nav-link {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="console-admin-standalone.html">
                <i class="fas fa-calculator me-2"></i>
                EasyProd - Simulations
            </a>
            <div class="navbar-nav ms-auto">
                <a href="console-admin-standalone.html" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Retour Console
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="main-container">
            <div class="page-header">
                <h1><i class="fas fa-chart-line me-3"></i>Centre de Simulations</h1>
                <p class="mb-0">Simulez vos chiffrages, plannings et analysez la rentabilité de vos projets</p>
            </div>

            <ul class="nav nav-tabs simulation-tabs" id="simulationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="chiffrage-tab" data-bs-toggle="tab" data-bs-target="#chiffrage" type="button" role="tab">
                        <i class="fas fa-euro-sign me-2"></i>Simulation Chiffrage
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="planning-tab" data-bs-toggle="tab" data-bs-target="#planning" type="button" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Simulation Planning
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rentabilite-tab" data-bs-toggle="tab" data-bs-target="#rentabilite" type="button" role="tab">
                        <i class="fas fa-chart-pie me-2"></i>Analyse Rentabilité
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="simulationTabContent">
                <!-- Onglet Chiffrage -->
                <div class="tab-pane fade show active" id="chiffrage" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="simulation-card">
                                <h4><i class="fas fa-calculator me-2"></i>Paramètres du Projet</h4>
                                
                                <div class="mb-3">
                                    <label for="projectName" class="form-label">Nom du projet</label>
                                    <input type="text" class="form-control" id="projectName" placeholder="Ex: Rénovation mobilier bureau">
                                </div>

                                <div class="mb-3">
                                    <label for="clientName" class="form-label">Client</label>
                                    <input type="text" class="form-control" id="clientName" placeholder="Nom du client">
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="totalSeats" class="form-label">Nombre de sièges</label>
                                        <input type="number" class="form-control" id="totalSeats" value="100" min="1">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="hourlyRate" class="form-label">Taux horaire (€)</label>
                                        <input type="number" class="form-control" id="hourlyRate" value="15.38" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="simulation-card">
                                <h4><i class="fas fa-cogs me-2"></i>Opérations</h4>
                                <div id="operationsList">
                                    <!-- Les opérations seront générées par JavaScript -->
                                </div>
                                <button type="button" class="btn btn-outline-primary" onclick="addOperationLine()">
                                    <i class="fas fa-plus me-2"></i>Ajouter une opération
                                </button>
                            </div>

                            <div class="simulation-card">
                                <h4><i class="fas fa-shopping-cart me-2"></i>Achats Externes</h4>
                                <div id="purchasesList">
                                    <div class="row mb-2">
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" placeholder="Description de l'achat">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" placeholder="Montant (€)" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary" onclick="addPurchase()">
                                    <i class="fas fa-plus me-2"></i>Ajouter un achat
                                </button>
                            </div>

                            <button type="button" class="btn btn-primary btn-lg w-100" onclick="calculateChiffrage()">
                                <i class="fas fa-calculator me-2"></i>Calculer le Chiffrage
                            </button>
                        </div>

                        <div class="col-lg-6">
                            <div class="simulation-card">
                                <h4><i class="fas fa-chart-bar me-2"></i>Résultats du Chiffrage</h4>
                                <div id="chiffrageResults">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                                        <p>Remplissez les paramètres et cliquez sur "Calculer" pour voir les résultats</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglet Planning -->
                <div class="tab-pane fade" id="planning" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="simulation-card">
                                <h4><i class="fas fa-calendar-alt me-2"></i>Paramètres Planning</h4>
                                
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">Date de début</label>
                                    <input type="date" class="form-control" id="startDate">
                                </div>

                                <div class="mb-3">
                                    <label for="workDaysPerWeek" class="form-label">Jours de travail par semaine</label>
                                    <select class="form-select" id="workDaysPerWeek">
                                        <option value="5">5 jours</option>
                                        <option value="6">6 jours</option>
                                        <option value="7">7 jours</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="hoursPerDay" class="form-label">Heures par jour</label>
                                    <input type="number" class="form-control" id="hoursPerDay" value="8" min="1" max="24">
                                </div>

                                <div class="mb-3">
                                    <label for="operatorsCount" class="form-label">Nombre d'opérateurs</label>
                                    <input type="number" class="form-control" id="operatorsCount" value="2" min="1">
                                </div>

                                <button type="button" class="btn btn-success btn-lg w-100" onclick="generatePlanning()">
                                    <i class="fas fa-calendar-plus me-2"></i>Générer le Planning
                                </button>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="simulation-card">
                                <h4><i class="fas fa-timeline me-2"></i>Planning Prévisionnel</h4>
                                <div id="planningResults">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-calendar fa-3x mb-3"></i>
                                        <p>Configurez les paramètres et générez le planning</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglet Rentabilité -->
                <div class="tab-pane fade" id="rentabilite" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="simulation-card">
                                <h4><i class="fas fa-euro-sign me-2"></i>Prix de Vente</h4>
                                
                                <div class="mb-3">
                                    <label for="salePrice" class="form-label">Prix de vente total (€)</label>
                                    <input type="number" class="form-control" id="salePrice" value="5000" step="0.01" min="0">
                                </div>

                                <div class="mb-3">
                                    <label for="marginTarget" class="form-label">Marge cible (%)</label>
                                    <input type="number" class="form-control" id="marginTarget" value="25" min="0" max="100">
                                </div>

                                <button type="button" class="btn btn-success btn-lg w-100" onclick="analyzeRentabilite()">
                                    <i class="fas fa-chart-pie me-2"></i>Analyser la Rentabilité
                                </button>
                            </div>

                            <div class="simulation-card">
                                <h4><i class="fas fa-sliders-h me-2"></i>Simulation Scénarios</h4>
                                
                                <div class="mb-3">
                                    <label class="form-label">Variation du taux horaire</label>
                                    <div class="row">
                                        <div class="col-4">
                                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="varyHourlyRate(-10)">-10%</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="varyHourlyRate(0)">Normal</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="varyHourlyRate(10)">+10%</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Variation du nombre de sièges</label>
                                    <div class="row">
                                        <div class="col-4">
                                            <button class="btn btn-outline-info btn-sm w-100" onclick="varySeatsCount(-20)">-20%</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-outline-info btn-sm w-100" onclick="varySeatsCount(0)">Normal</button>
                                        </div>
                                        <div class="col-4">
                                            <button class="btn btn-outline-info btn-sm w-100" onclick="varySeatsCount(20)">+20%</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="simulation-card">
                                <h4><i class="fas fa-chart-pie me-2"></i>Analyse de Rentabilité</h4>
                                <div id="rentabiliteResults">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-calculator fa-3x mb-3"></i>
                                        <p>Lancez l'analyse pour voir les résultats</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour sélectionner une opération -->
    <div class="modal fade" id="operationSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cogs me-2"></i>Sélectionner une Opération</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryFilter" class="form-label">Filtrer par catégorie :</label>
                        <select class="form-select" id="categoryFilter" onchange="filterOperationsByCategory()">
                            <option value="">Toutes les catégories</option>
                        </select>
                    </div>
                    <div class="operations-panel" id="availableOperations">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Chargement des opérations...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="selectOperation()">Sélectionner</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://your-supabase-url.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';

        // Variables globales
        let supabase = null;
        let allOperationsFromDB = [];
        let filteredOperations = [];
        let selectedOperationForModal = null;
        let currentOperationLineIndex = -1;
        let operationLines = [];
        let purchases = [];
        let currentSimulation = {};

        // Opérations par défaut (fallback)
        const defaultOperations = [
            { id: 1, name: 'Démontage', category: 'Désassemblage', average_time_per_unit: 0.5, unit: 'pièce' },
            { id: 2, name: 'Nettoyage roulettes', category: 'Nettoyage', average_time_per_unit: 0.3, unit: 'pièce' },
            { id: 3, name: 'Peinture roulettes', category: 'Rénovation', average_time_per_unit: 0.8, unit: 'pièce' },
            { id: 4, name: 'Nettoyage structure', category: 'Nettoyage', average_time_per_unit: 0.4, unit: 'pièce' },
            { id: 5, name: 'Peinture structure', category: 'Rénovation', average_time_per_unit: 1.2, unit: 'pièce' },
            { id: 6, name: 'Assemblage final', category: 'Assemblage', average_time_per_unit: 0.7, unit: 'pièce' },
            { id: 7, name: 'Contrôle qualité', category: 'Qualité', average_time_per_unit: 0.2, unit: 'pièce' },
            { id: 8, name: 'Emballage', category: 'Finition', average_time_per_unit: 0.3, unit: 'pièce' }
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            initializeSupabase();
            await loadOperationsFromDB();
            setDefaultDate();
            renderOperationLines();
        });

        async function initializeSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ Supabase initialisé');
                } else {
                    console.warn('⚠️ Supabase non disponible, mode fallback');
                }
            } catch (error) {
                console.warn('⚠️ Erreur initialisation Supabase:', error);
            }
        }

        async function loadOperationsFromDB() {
            try {
                if (!supabase) {
                    throw new Error('Supabase non disponible');
                }

                const { data, error } = await supabase
                    .from('operations')
                    .select('*')
                    .eq('is_active', true)
                    .order('category', { ascending: true })
                    .order('name', { ascending: true });

                if (error) throw error;

                allOperationsFromDB = data || [];
                
                if (allOperationsFromDB.length === 0) {
                    throw new Error('Aucune opération trouvée');
                }

                console.log('✅ Opérations chargées depuis la base:', allOperationsFromDB.length);
                
            } catch (error) {
                console.warn('⚠️ Erreur chargement opérations, utilisation du fallback:', error);
                allOperationsFromDB = defaultOperations;
            }

           // Initialiser les catégories (async)
            await populateCategoryFilter();
        }
        async function loadCategoriesFromSupabase() {
    try {
        if (!supabase) {
            throw new Error('Supabase non disponible');
        }

        // Récupérer toutes les catégories distinctes depuis la table operations
        const { data, error } = await supabase
            .from('operations')
            .select('category')
            .eq('is_active', true)
            .not('category', 'is', null);

        if (error) throw error;

        // Extraire les catégories uniques et les trier
        const categories = [...new Set(data.map(op => op.category))].sort();
        
        return categories;

    } catch (error) {
        console.warn('⚠️ Erreur chargement catégories depuis Supabase, utilisation du fallback:', error);
        // Fallback avec les catégories que vous mentionnez
        return ['production', 'logistique', 'operation light', 'organisation', 'représentation'];
    }
}
        async function populateCategoryFilter() {
    // Récupérer les catégories depuis Supabase
    const categories = await loadCategoriesFromSupabase();
    
    const categoryFilter = document.getElementById('categoryFilter');
    
    categoryFilter.innerHTML = '<option value="">Toutes les catégories</option>';
    categories.forEach(category => {
        categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
    });
}

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
        }

        function renderOperationLines() {
            const container = document.getElementById('operationsList');
            container.innerHTML = operationLines.map((line, index) => `
                <div class="operation-row">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <label class="form-label small">Opération sélectionnée :</label>
                            <div class="d-flex align-items-center">
                                <span class="me-2">${line.operation ? line.operation.name : 'Aucune opération sélectionnée'}</span>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-1" 
                                    onclick="openOperationSelection(${index})">
                                <i class="fas fa-search me-1"></i>Choisir une opération
                            </button>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Quantité :</label>
                            <input type="number" class="form-control form-control-sm" 
                                value="${line.quantity || ''}" 
                                min="0" 
                                placeholder="Auto"
                                onchange="updateOperationLine(${index}, 'quantity', parseInt(this.value))"
                                title="Laissez vide pour utiliser le nombre total de sièges">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label small">&nbsp;</label>
                            <button class="btn btn-outline-danger btn-sm d-block" onclick="removeOperationLine(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            if (operationLines.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-cogs fa-2x mb-2"></i>
                        <p>Aucune opération ajoutée. Cliquez sur "Ajouter une opération" pour commencer.</p>
                    </div>
                `;
            }
        }

        function addOperationLine() {
            operationLines.push({
                operation: null,
                timePerUnit: 1.0,
                quantity: null
            });
            renderOperationLines();
        }

        function removeOperationLine(index) {
            operationLines.splice(index, 1);
            renderOperationLines();
        }

        function updateOperationLine(index, field, value) {
            operationLines[index][field] = value;
        }

        function openOperationSelection(lineIndex) {
            currentOperationLineIndex = lineIndex;
            selectedOperationForModal = null;
            
            // Réinitialiser le filtre
            document.getElementById('categoryFilter').value = '';
            filterOperationsByCategory();
            
            // Ouvrir la modal
            const modal = new bootstrap.Modal(document.getElementById('operationSelectionModal'));
            modal.show();
        }

        function filterOperationsByCategory() {
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            if (selectedCategory === '') {
                filteredOperations = [...allOperationsFromDB];
            } else {
                filteredOperations = allOperationsFromDB.filter(op => op.category === selectedCategory);
            }
            
            renderAvailableOperations();
        }

        function renderAvailableOperations() {
            const container = document.getElementById('availableOperations');
            
            if (filteredOperations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>Aucune opération trouvée pour cette catégorie</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOperations.map(operation => `
                <div class="operation-item" onclick="selectOperationFromList(${operation.id})" data-operation-id="${operation.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${operation.name}</div>
                            <small class="text-muted">
                                ${operation.average_time_per_unit || 1.0}h par ${operation.unit || 'pièce'}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-info category-badge">${operation.category}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectOperationFromList(operationId) {
            // Désélectionner toutes les opérations
            document.querySelectorAll('.operation-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Sélectionner l'opération cliquée
            const clickedItem = document.querySelector(`[data-operation-id="${operationId}"]`);
            if (clickedItem) {
                clickedItem.classList.add('selected');
                selectedOperationForModal = allOperationsFromDB.find(op => op.id === operationId);
            }
        }

        function selectOperation() {
            if (!selectedOperationForModal || currentOperationLineIndex === -1) {
                alert('Veuillez sélectionner une opération');
                return;
            }
            
            // Mettre à jour la ligne d'opération
            operationLines[currentOperationLineIndex].operation = selectedOperationForModal;
            operationLines[currentOperationLineIndex].timePerUnit = selectedOperationForModal.average_time_per_unit || 1.0;
            
            // Fermer la modal
            bootstrap.Modal.getInstance(document.getElementById('operationSelectionModal')).hide();
            
            // Re-render les lignes d'opérations
            renderOperationLines();
            
            // Réinitialiser les variables
            currentOperationLineIndex = -1;
            selectedOperationForModal = null;
        }

        function addPurchase() {
            const container = document.getElementById('purchasesList');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-2';
            newRow.innerHTML = `
                <div class="col-md-7">
                    <input type="text" class="form-control" placeholder="Description de l'achat">
                </div>
                <div class="col-md-4">
                    <input type="number" class="form-control" placeholder="Montant (€)" step="0.01">
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-danger btn-sm" onclick="this.closest('.row').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(newRow);
        }

        function calculateChiffrage() {
            const totalSeats = parseInt(document.getElementById('totalSeats').value) || 0;
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

            if (operationLines.length === 0) {
                alert('Veuillez ajouter au moins une opération');
                return;
            }

            // Calculer le coût des opérations
            let totalOperationHours = 0;
            let operationBreakdown = [];

            operationLines.forEach((line, index) => {
                if (!line.operation) {
                    return; // Ignorer les lignes sans opération sélectionnée
                }

                const quantity = line.quantity || totalSeats; // Utiliser totalSeats si pas de quantité spécifique
                const timePerUnit = line.timePerUnit || line.operation.average_time_per_unit || 1.0;
                const hours = timePerUnit * quantity;
                const cost = hours * hourlyRate;
                
                totalOperationHours += hours;
                
                operationBreakdown.push({
                    name: line.operation.name,
                    category: line.operation.category,
                    quantity: quantity,
                    timePerUnit: timePerUnit,
                    hours: hours,
                    cost: cost
                });
            });

            const operationsCost = totalOperationHours * hourlyRate;

            // Calculer les achats externes
            const purchaseRows = document.querySelectorAll('#purchasesList .row');
            let externalPurchases = 0;
            let purchaseBreakdown = [];

            purchaseRows.forEach(row => {
                const description = row.querySelector('input[type="text"]').value;
                const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
                if (description && amount > 0) {
                    externalPurchases += amount;
                    purchaseBreakdown.push({ description, amount });
                }
            });

            const totalCost = operationsCost + externalPurchases;

            // Stocker la simulation
            currentSimulation = {
                totalSeats,
                hourlyRate,
                operationsCost,
                externalPurchases,
                totalCost,
                totalHours: totalOperationHours,
                operationBreakdown,
                purchaseBreakdown
            };

            renderChiffrageResults();
        }

        function renderChiffrageResults() {
            const container = document.getElementById('chiffrageResults');
            const sim = currentSimulation;

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value neutral">${sim.totalCost.toFixed(2)}€</div>
                            <div class="metric-label">Coût Total</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value neutral">${sim.totalHours.toFixed(1)}h</div>
                            <div class="metric-label">Temps Total</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value positive">${sim.operationsCost.toFixed(2)}€</div>
                            <div class="metric-label">Coût Opérateurs</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value positive">${sim.externalPurchases.toFixed(2)}€</div>
                            <div class="metric-label">Achats Externes</div>
                        </div>
                    </div>
                </div>

                <div class="results-card">
                    <h5><i class="fas fa-list me-2"></i>Détail des Opérations</h5>
                    ${sim.operationBreakdown.map(op => `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: white; border-radius: 6px;">
                            <div>
                                <div class="fw-bold">${op.name}</div>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">${op.quantity} × ${op.timePerUnit}h</small>
                                    <span class="badge bg-secondary category-badge">${op.category}</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small">${op.hours.toFixed(1)}h</div>
                                <div class="text-success fw-bold">${op.cost.toFixed(2)}€</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${sim.purchaseBreakdown.length > 0 ? `
                    <div class="results-card">
                        <h5><i class="fas fa-shopping-cart me-2"></i>Achats Externes</h5>
                        ${sim.purchaseBreakdown.map(purchase => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: white; border-radius: 6px;">
                                <div class="fw-bold">${purchase.description}</div>
                                <div class="text-success fw-bold">${purchase.amount.toFixed(2)}€</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        function generatePlanning() {
            if (!currentSimulation.totalHours) {
                alert('Veuillez d\'abord calculer un chiffrage');
                return;
            }

            const startDate = new Date(document.getElementById('startDate').value);
            const workDaysPerWeek = parseInt(document.getElementById('workDaysPerWeek').value);
            const hoursPerDay = parseInt(document.getElementById('hoursPerDay').value);
            const operatorsCount = parseInt(document.getElementById('operatorsCount').value);

            const totalWorkHours = currentSimulation.totalHours;
            const dailyCapacity = hoursPerDay * operatorsCount;
            const daysNeeded = Math.ceil(totalWorkHours / dailyCapacity);

            // Calcul des dates en tenant compte des jours de travail
            let planningDays = [];
            let currentDate = new Date(startDate);
            let workDaysAdded = 0;

            while (workDaysAdded < daysNeeded) {
                const dayOfWeek = currentDate.getDay();
                let isWorkDay = false;

                if (workDaysPerWeek === 5) {
                    isWorkDay = dayOfWeek >= 1 && dayOfWeek <= 5; // Lun-Ven
                } else if (workDaysPerWeek === 6) {
                    isWorkDay = dayOfWeek >= 1 && dayOfWeek <= 6; // Lun-Sam
                } else {
                    isWorkDay = true; // 7 jours
                }

                if (isWorkDay) {
                    planningDays.push(new Date(currentDate));
                    workDaysAdded++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Répartition des opérations par jour
            let dailyPlanning = [];
            let remainingHours = totalWorkHours;
            
            planningDays.forEach((date, index) => {
                const hoursForDay = Math.min(remainingHours, dailyCapacity);
                remainingHours -= hoursForDay;
                
                dailyPlanning.push({
                    date: date,
                    hours: hoursForDay,
                    operations: assignOperationsToDay(hoursForDay, index)
                });
            });

            renderPlanningResults(dailyPlanning, daysNeeded);
        }

        function assignOperationsToDay(availableHours, dayIndex) {
            // Logique simplifiée pour assigner les opérations aux jours
            let assignedOps = [];
            let usedHours = 0;

            currentSimulation.operationBreakdown.forEach((op, opIndex) => {
                if (usedHours < availableHours) {
                    const maxQuantityForDay = Math.floor((availableHours - usedHours) / op.timePerUnit);
                    const quantityToAssign = Math.min(maxQuantityForDay, Math.max(1, Math.floor(op.quantity / 3))); // Répartir sur plusieurs jours
                    
                    if (quantityToAssign > 0) {
                        const hoursForThisOp = quantityToAssign * op.timePerUnit;
                        assignedOps.push({
                            name: op.name,
                            category: op.category,
                            quantity: quantityToAssign,
                            hours: hoursForThisOp
                        });
                        usedHours += hoursForThisOp;
                    }
                }
            });

            return assignedOps;
        }

        function renderPlanningResults(dailyPlanning, totalDays) {
            const container = document.getElementById('planningResults');
            
            container.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value neutral">${totalDays}</div>
                            <div class="metric-label">Jours de Travail</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value neutral">${dailyPlanning[0]?.date.toLocaleDateString('fr-FR') || 'N/A'}</div>
                            <div class="metric-label">Date de Début</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value neutral">${dailyPlanning[dailyPlanning.length - 1]?.date.toLocaleDateString('fr-FR') || 'N/A'}</div>
                            <div class="metric-label">Date de Fin</div>
                        </div>
                    </div>
                </div>

                <div class="planning-timeline">
                    ${dailyPlanning.map((day, index) => `
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-2">
                                        <i class="fas fa-calendar me-2"></i>
                                        ${day.date.toLocaleDateString('fr-FR', { 
                                            weekday: 'long', 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric' 
                                        })}
                                    </h6>
                                    <div class="mb-2">
                                        <strong>${day.hours.toFixed(1)}h</strong> de travail planifiées
                                    </div>
                                    ${day.operations.length > 0 ? `
                                        <div class="mt-2">
                                            <small class="text-muted">Opérations :</small>
                                            ${day.operations.map(op => `
                                                <div class="ms-3 d-flex align-items-center">
                                                    <i class="fas fa-arrow-right me-1"></i>
                                                    <span class="me-2">${op.name} : ${op.quantity} unités (${op.hours.toFixed(1)}h)</span>
                                                    <span class="badge bg-secondary category-badge">${op.category}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary">Jour ${index + 1}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function analyzeRentabilite() {
            if (!currentSimulation.totalCost) {
                alert('Veuillez d\'abord calculer un chiffrage');
                return;
            }

            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const marginTarget = parseFloat(document.getElementById('marginTarget').value) || 0;

            const totalCost = currentSimulation.totalCost;
            const profit = salePrice - totalCost;
            const marginPercent = salePrice > 0 ? (profit / salePrice) * 100 : 0;
            const markupPercent = totalCost > 0 ? (profit / totalCost) * 100 : 0;

            const analysis = {
                salePrice,
                totalCost,
                profit,
                marginPercent,
                markupPercent,
                marginTarget,
                isTargetMet: marginPercent >= marginTarget
            };

            renderRentabiliteResults(analysis);
        }

        function renderRentabiliteResults(analysis) {
            const container = document.getElementById('rentabiliteResults');
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value neutral">${analysis.salePrice.toFixed(2)}€</div>
                            <div class="metric-label">Prix de Vente</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value neutral">${analysis.totalCost.toFixed(2)}€</div>
                            <div class="metric-label">Coût Total</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="metric-card">
                            <div class="metric-value ${analysis.profit >= 0 ? 'positive' : 'negative'}">${analysis.profit.toFixed(2)}€</div>
                            <div class="metric-label">Bénéfice ${analysis.profit >= 0 ? '📈' : '📉'}</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value ${analysis.marginPercent >= analysis.marginTarget ? 'positive' : 'negative'}">
                                ${analysis.marginPercent.toFixed(1)}%
                            </div>
                            <div class="metric-label">Marge Réelle</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <div class="metric-value ${analysis.isTargetMet ? 'positive' : 'negative'}">
                                ${analysis.marginTarget.toFixed(1)}%
                            </div>
                            <div class="metric-label">Marge Cible</div>
                        </div>
                    </div>
                </div>

                <div class="results-card">
                    <h5><i class="fas fa-chart-pie me-2"></i>Analyse Détaillée</h5>
                    
                    <div class="mb-3">
                        <strong>Statut de la Marge :</strong>
                        <span class="ms-2 badge ${analysis.isTargetMet ? 'bg-success' : 'bg-danger'}">
                            ${analysis.isTargetMet ? '✅ Objectif Atteint' : '❌ Objectif Non Atteint'}
                        </span>
                    </div>

                    <div class="mb-3">
                        <strong>Markup :</strong> ${analysis.markupPercent.toFixed(1)}%
                        <small class="text-muted ms-2">(Marge sur coût)</small>
                    </div>

                    <div class="mb-3">
                        <strong>Répartition des Coûts :</strong>
                        <div class="mt-2">
                            <div class="d-flex justify-content-between">
                                <span>Coût Opérateurs :</span>
                                <span>${currentSimulation.operationsCost.toFixed(2)}€ (${((currentSimulation.operationsCost/analysis.totalCost)*100).toFixed(1)}%)</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Achats Externes :</span>
                                <span>${currentSimulation.externalPurchases.toFixed(2)}€ (${((currentSimulation.externalPurchases/analysis.totalCost)*100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    ${!analysis.isTargetMet ? `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Recommandations</h6>
                            <ul class="mb-0">
                                <li>Prix de vente minimum pour atteindre ${analysis.marginTarget}% : <strong>${(analysis.totalCost / (1 - analysis.marginTarget/100)).toFixed(2)}€</strong></li>
                                <li>Coût maximum pour maintenir le prix actuel : <strong>${(analysis.salePrice * (1 - analysis.marginTarget/100)).toFixed(2)}€</strong></li>
                            </ul>
                        </div>
                    ` : `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Excellent ! Votre marge dépasse l'objectif de ${(analysis.marginPercent - analysis.marginTarget).toFixed(1)} points.
                        </div>
                    `}
                </div>
            `;
        }

        function varyHourlyRate(percentage) {
            const currentRate = parseFloat(document.getElementById('hourlyRate').value) || 15.38;
            const newRate = currentRate * (1 + percentage / 100);
            document.getElementById('hourlyRate').value = newRate.toFixed(2);
            
            if (currentSimulation.totalCost) {
                calculateChiffrage();
                if (document.getElementById('rentabiliteResults').innerHTML.includes('metric-card')) {
                    analyzeRentabilite();
                }
            }
        }

        function varySeatsCount(percentage) {
            const currentSeats = parseInt(document.getElementById('totalSeats').value) || 100;
            const newSeats = Math.round(currentSeats * (1 + percentage / 100));
            document.getElementById('totalSeats').value = newSeats;
            
            if (currentSimulation.totalCost) {
                calculateChiffrage();
                if (document.getElementById('rentabiliteResults').innerHTML.includes('metric-card')) {
                    analyzeRentabilite();
                }
            }
        }
    </script>
</body>
</html>
