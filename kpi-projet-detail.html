<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Projet Détail - EasyProd Manager</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --manager-color: #8e44ad;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: var(--primary-color) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 90vh;
            margin-top: 20px;
            padding: 30px;
        }

        .project-header {
            background: linear-gradient(135deg, var(--manager-color), #9b59b6);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
        }

        .project-title {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 300;
        }

        .project-meta {
            opacity: 0.9;
            margin-top: 15px;
            font-size: 1.1rem;
        }

        .kpi-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .kpi-value.positive {
            color: var(--success-color);
        }

        .kpi-value.negative {
            color: var(--danger-color);
        }

        .kpi-value.neutral {
            color: var(--primary-color);
        }

        .kpi-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .operations-table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        .correction-cell {
            min-width: 200px;
        }

        .correction-input {
            width: 80px;
            display: inline-block;
            margin: 0 5px;
        }

        .correction-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-right: 5px;
        }
        .operations-table thead {
            background: var(--primary-color);
            color: white;
        }

        .operations-table th,
        .operations-table td {
            padding: 15px;
            vertical-align: middle;
        }

        .operation-row-excess {
            background-color: #f8d7da !important;
            border-color: var(--danger-color) !important;
        }

        .operation-row-excess td {
            color: #721c24 !important;
            font-weight: 500;
        }

        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.success {
            background: linear-gradient(90deg, var(--success-color), #2ecc71);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning-color), #f1c40f);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger-color), #e67e22);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .history-item {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .history-item.recent {
            border-left-color: var(--success-color);
            background: #d4f6d4;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-operator {
            font-weight: 600;
            color: var(--primary-color);
        }

        .history-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .history-details {
            color: #495057;
            font-size: 0.95rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            font-weight: 500;
            color: var(--dark-color);
        }

        .breakdown-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .breakdown-value.negative {
            color: var(--danger-color);
        }

        .breakdown-value.positive {
            color: var(--success-color);
        }

        .purchase-item {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .purchase-amount {
            font-weight: bold;
            color: var(--warning-color);
            font-size: 1.1rem;
        }

        .purchase-description {
            color: #856404;
            margin-top: 5px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .add-purchase-form {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                padding: 20px;
            }

            .kpi-row {
                grid-template-columns: 1fr;
            }

            .project-title {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-crown me-2"></i>
                EasyProd Manager - Détail Projet
            </a>
            <div class="navbar-nav ms-auto">
                    <a href="console-admin-standalone.html" class="btn btn-outline-light me-3">
                        <i class="fas fa-arrow-left me-2"></i>Retour Console admin
                    </a>
                <button class="btn btn-outline-light me-3" onclick="goBack()">
                    <i class="fas fa-arrow-left me-1"></i>
                    Précédent
                </button>
                <button class="btn btn-outline-light me-3" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Actualiser
                </button>
                <span class="navbar-text">
                    <i class="fas fa-user-crown me-1"></i>
                    Manager
                </span>
            </div>
        </div>
    </nav>

    <!-- Container principal -->
    <div class="container-fluid">
        <div class="main-container">
            <!-- En-tête du projet -->
            <div class="project-header" id="projectHeader">
                <div class="loading-spinner"></div>
                <span class="ms-2">Chargement du projet...</span>
            </div>
            
            <!-- Résumé KPI -->
            <div class="kpi-summary">
                <h4 class="mb-4">
                    <i class="fas fa-chart-pie me-2"></i>
                    Résumé Financier
                </h4>
                <div class="kpi-row" id="kpiSummary">
                    <!-- Chargement dynamique -->
                </div>
            </div>

            <!-- Détails de la rentabilité -->
            <div class="section-card">
                <h4 class="section-title">
                    <i class="fas fa-calculator me-2"></i>
                    Détails de la Rentabilité
                </h4>
                <div id="rentabilityBreakdown">
                    <!-- Chargement dynamique -->
                </div>
            </div>

            <!-- Achats externes -->
            <div class="section-card">
                <h4 class="section-title">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Achats Externes
                    <button class="btn btn-sm btn-outline-primary ms-3" onclick="showAddPurchaseForm()">
                        <i class="fas fa-plus me-1"></i>
                        Ajouter
                    </button>
                </h4>
                <div id="purchasesList">
                    <!-- Chargement dynamique -->
                </div>
                <div id="addPurchaseForm" class="add-purchase-form" style="display: none;">
                    <h6>Nouvel Achat Externe</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="number" class="form-control" id="purchaseAmount" placeholder="Montant €" step="0.01">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="purchaseDescription" placeholder="Description">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success" onclick="addPurchase()">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-secondary ms-1" onclick="cancelAddPurchase()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avancement par opération -->
            <div class="section-card">
                <h4 class="section-title">
                    <i class="fas fa-tasks me-2"></i>
                    Avancement par Opération
                </h4>
                <div class="table-responsive">
                    <table class="table operations-table" id="operationsTable">
                        <thead>
                            <tr>
                                <th>Opération</th>
                                <th>Progression</th>
                                <th>Quantités</th>
                                <th>Avancement</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Chargement dynamique -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="row">
                <div class="col-md-6">
                    <div class="section-card">
                        <h4 class="section-title">
                            <i class="fas fa-chart-line me-2"></i>
                            Progression dans le Temps
                        </h4>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="section-card">
                        <h4 class="section-title">
                            <i class="fas fa-chart-doughnut me-2"></i>
                            Répartition des Coûts
                        </h4>
                        <div class="chart-container">
                            <canvas id="costsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique des déclarations -->
            <div class="section-card">
                <h4 class="section-title">
                    <i class="fas fa-history me-2"></i>
                    Historique des Déclarations
                </h4>
                <div id="declarationsHistory">
                    <!-- Chargement dynamique -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script>
        // Configuration Supabase
        
    const SUPABASE_URL = CONFIG.SUPABASE.URL;
    const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;
    </script>
        // Variables globales
        let supabase = null;
        let projectId = null;
        let projectData = null;
        let progressChart = null;
        let costsChart = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initialisation KPI Projet Détail');
            
            // Récupérer l'ID du projet depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');
            
            if (!projectId) {
                showToast('ID de projet manquant', 'error');
                setTimeout(() => goBack(), 2000);
                return;
            }
            
            try {
                // Initialiser Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Charger les données du projet
                await loadProjectData();
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showToast('Erreur de connexion - Utilisation des données de test', 'warning');
            }
        });

        // Chargement des données du projet
        async function loadProjectData() {
            try {
                // Récupérer les données du projet
                const { data: project, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error) throw error;

                if (project) {
                    // Enrichir avec les données calculées
                    projectData = await enrichProjectData(project);
                } else {
                    throw new Error('Projet non trouvé');
                }
                
                renderProjectDetail();
                
            } catch (error) {
                console.error('Erreur chargement projet:', error);
                showToast('Projet non trouvé', 'error');
                setTimeout(() => goBack(), 2000);
            }
        }

        // Enrichir les données du projet
        async function enrichProjectData(project) {
            try {
                // 1. Récupérer la configuration du projet depuis project_details
                const { data: projectConfig, error: configError } = await supabase
                    .from('project_details')
                    .select('selected_operations, budget_prestation, taux_horaire, nombre_sieges')
                    .eq('project_id', parseInt(project.id))
                    .single();

                if (configError && !configError.message.includes('No rows returned')) {
                    console.warn('Erreur configuration projet:', configError);
                }

                let operations = [];
                let prixVentePrestation = 0;
                let coutOperateurs = 0;

                if (projectConfig && projectConfig.selected_operations) {
                    // 2. Parser les IDs des opérations sélectionnées
                    const selectedOperationIds = JSON.parse(projectConfig.selected_operations);
                    
                    if (Array.isArray(selectedOperationIds) && selectedOperationIds.length > 0) {
                        // 3. Récupérer les détails des opérations depuis la table operations
                        const { data: operationsData, error: opsError } = await supabase
                            .from('operations')
                            .select('*')
                            .in('id', selectedOperationIds);

                        if (!opsError && operationsData) {
                            // 4. Récupérer les vraies données de déclarations/tâches
                            const { data: tasks, error: tasksError } = await supabase
                                .from('tasks')
                                .select('operation_id, quantity')
                                .eq('project_id', parseInt(project.id));

                            // Calculer les quantités réalisées par opération
                            const realizedByOperation = {};
                            if (tasks && !tasksError) {
                                tasks.forEach(task => {
                                    if (!realizedByOperation[task.operation_id]) {
                                        realizedByOperation[task.operation_id] = 0;
                                    }
                                    realizedByOperation[task.operation_id] += task.quantity || 0;
                                });
                            }

                            // 5. Calculer les métriques pour chaque opération
                            operations = operationsData.map(op => {
                                const totalUnits = projectConfig.nombre_sieges || project.total_seats || 0;
                                const realized = realizedByOperation[op.id] || 0;
                                
                                return {
                                    id: op.id,
                                    name: op.name,
                                    category: op.category,
                                    total: totalUnits,
                                    realized: realized,
                                    unit: op.unit || 'pièce',
                                    average_time: op.average_time_per_unit || 1.0
                                };
                            });

                            // 6. Calculer les coûts des opérateurs avec les vraies données
                            const tauxHoraire = projectConfig.taux_horaire || 15.38;
                            coutOperateurs = operations.reduce((total, op) => {
                                return total + (op.realized * op.average_time * tauxHoraire);
                            }, 0);
                        }
                    }

                    // Prix de vente depuis la configuration
                    const { data: projectCommands, error: commandsError } = await supabase
    .from('commandes_odoo')
    .select('prix_vente_prestation')
    .eq('project_id', parseInt(project.id));

if (!commandsError && projectCommands) {
    prixVentePrestation = projectCommands.reduce((sum, cmd) => 
        sum + (cmd.prix_vente_prestation || 0), 0);
}
                }

                // 7. Récupérer les achats externes
                const { data: purchases, error: purchasesError } = await supabase
                    .from('project_purchases')
                    .select('*')
                    .eq('project_id', parseInt(project.id))
                    .order('created_at', { ascending: false });

                const achatsExternes = purchases ? purchases.reduce((total, p) => total + p.amount, 0) : 0;

                // 8. Récupérer l'historique des déclarations avec plus de détails
                let declarations = [];
                try {
                    const { data: declData, error: declError } = await supabase
                        .from('tasks')
                        .select(`
                            id,
                            operator_name,
                            operation_id,
                            operation_name,
                            quantity,
                            execution_ms,
                            started_at,
                            ended_at,
                            created_at
                        `)
                        .eq('project_id', parseInt(project.id))
                        .order('created_at', { ascending: false })
                        .limit(50);
                    
                    if (declError) {
                        console.warn('Erreur récupération déclarations:', declError);
                    } else {
                        declarations = (declData || []).map(task => ({
                            id: task.id,
                            operator: task.operator_name || 'Opérateur inconnu',
                            operation: task.operation_name || 'Opération inconnue',
                            quantity: task.quantity || 0,
                            time: task.execution_ms ? formatExecutionTime(task.execution_ms) : 'N/A',
                            date: task.created_at || task.ended_at || task.started_at
                        }));
                    }
                } catch (error) {
                    console.error('Erreur récupération déclarations:', error);
                    declarations = [];
                }

                // 9. Calculer les sièges emballés (opération d'emballage)
                const emballageOp = operations.find(op => 
                    op.name.toLowerCase().includes('emballage') || 
                    op.name.toLowerCase().includes('assemblage')
                );
                const emballedSeats = emballageOp ? emballageOp.realized : 
                    operations.length > 0 ? Math.min(...operations.map(op => op.realized)) : 0;

                return {
                    ...project,
                    id: project.id,
                    name: project.name,
                    client: project.client || 'Client non défini',
                    prixVentePrestation: prixVentePrestation,
                    coutOperateurs: coutOperateurs,
                    achatsExternes: achatsExternes,
                    totalSeats: project.total_seats || 0,
                    emballedSeats: emballedSeats,
                    operations: operations,
                    purchases: purchases || [],
                    declarations: declarations
                };

            } catch (error) {
                console.error('Erreur enrichissement données projet:', error);
                
                // Fallback en cas d'erreur
                return {
                    ...project,
                    id: project.id,
                    name: project.name,
                    client: project.client || 'Client non défini',
                    prixVentePrestation: 0,
                    coutOperateurs: 0,
                    achatsExternes: 0,
                    totalSeats: project.total_seats || 0,
                    emballedSeats: 0,
                    operations: [],
                    purchases: [],
                    declarations: []
                };
            }
        }

        // Fonction utilitaire pour formater le temps d'exécution
        function formatExecutionTime(executionMs) {
            if (!executionMs || executionMs <= 0) return 'N/A';
            
            const totalMinutes = Math.round(executionMs / 1000 / 60);
            if (totalMinutes < 60) {
                return `${totalMinutes}min`;
            } else {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return minutes > 0 ? `${hours}h${minutes}min` : `${hours}h`;
            }
        }

        // Affichage du détail du projet
        function renderProjectDetail() {
            if (!projectData) return;

            // En-tête du projet
            renderProjectHeader();
            
            // Résumé KPI
            renderKPISummary();
            
            // Détail de rentabilité
            renderRentabilityBreakdown();
            
            // Achats externes
            renderPurchases();
            
            // Tableau des opérations
            renderOperationsTable();
            
            // Graphiques
            renderCharts();
            
            // Historique
            renderDeclarationsHistory();
        }

        // En-tête du projet
        function renderProjectHeader() {
            const header = document.getElementById('projectHeader');
            const rentabilite = projectData.prixVentePrestation - (projectData.coutOperateurs + projectData.achatsExternes);
            const avancement = Math.round((projectData.emballedSeats / projectData.totalSeats) * 100);
            
            header.innerHTML = `
                <h1 class="project-title">${projectData.name}</h1>
                <div class="project-meta">
                    <span class="me-4">
                        <i class="fas fa-building me-2"></i>
                        ${projectData.client}
                    </span>
                    <span class="me-4">
                        <i class="fas fa-calendar me-2"></i>
                        Créé le ${formatDate(projectData.created_at)}
                    </span>
                    <span class="me-4">
                        <i class="fas fa-chair me-2"></i>
                        ${projectData.totalSeats} sièges
                    </span>
                </div>
            `;
        }

        // Résumé KPI
        function renderKPISummary() {
            const container = document.getElementById('kpiSummary');
            const rentabilite = projectData.prixVentePrestation - (projectData.coutOperateurs + projectData.achatsExternes);
            const coutTotal = projectData.coutOperateurs + projectData.achatsExternes;
            const margePercent = projectData.prixVentePrestation > 0 ? ((rentabilite / projectData.prixVentePrestation) * 100) : 0;
            
            container.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-value neutral">${projectData.prixVentePrestation.toFixed(0)}</div>
                    <div class="kpi-label">Prix de Vente (hors logistique)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value neutral">${coutTotal.toFixed(0)}</div>
                    <div class="kpi-label">Dépenses à date</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value ${rentabilite >= 0 ? 'positive' : 'negative'}">${rentabilite.toFixed(0)}</div>
                    <div class="kpi-label">Marge restante</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value ${margePercent >= 20 ? 'positive' : margePercent >= 10 ? 'neutral' : 'negative'}">${margePercent.toFixed(1)}%</div>
                    <div class="kpi-label">Taux de marge provisoire</div>
                </div>
            `;
        }

        // Détail de rentabilité
        function renderRentabilityBreakdown() {
            const container = document.getElementById('rentabilityBreakdown');
            const rentabilite = projectData.prixVentePrestation - (projectData.coutOperateurs + projectData.achatsExternes);
            
            container.innerHTML = `
                <div class="breakdown-item">
                    <span class="breakdown-label">
                        <i class="fas fa-minus-circle text-danger me-2"></i>
                        Coût opérateurs
                    </span>
                    <span class="breakdown-value negative">-${projectData.coutOperateurs.toFixed(2)} €</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">
                        <i class="fas fa-minus-circle text-danger me-2"></i>
                        Achats externes
                    </span>
                    <span class="breakdown-value negative">-${projectData.achatsExternes.toFixed(2)} €</span>
                </div>
                <hr>
                <div class="breakdown-item">
                    <span class="breakdown-label">
                        <i class="fas fa-equals me-2"></i>
                        <strong>Marge restante à date</strong>
                    </span>
                    <span class="breakdown-value ${rentabilite >= 0 ? 'positive' : 'negative'}">
                        <strong>${rentabilite.toFixed(2)} €</strong>
                    </span>
                </div>
            `;
        }

        // Achats externes
        function renderPurchases() {
            const container = document.getElementById('purchasesList');
            
            if (!projectData.purchases || projectData.purchases.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucun achat externe déclaré</p>';
                return;
            }
            
            container.innerHTML = projectData.purchases.map(purchase => `
                <div class="purchase-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="purchase-amount">${purchase.amount.toFixed(2)} €</div>
                            <div class="purchase-description">${purchase.description}</div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${formatDate(purchase.date)}</small>
                            <br>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Tableau des opérations
        function renderOperationsTable() {
            const tbody = document.querySelector('#operationsTable tbody');
            
            if (!projectData.operations || projectData.operations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucune opération configurée</td></tr>';
                return;
            }
            
            tbody.innerHTML = projectData.operations.map(op => {
                const progress = op.total > 0 ? Math.round((op.realized / op.total) * 100) : 0;
                const progressClass = progress >= 80 ? 'success' : progress >= 50 ? 'warning' : 'danger';
                const statusClass = progress >= 100 ? 'success' : progress > 0 ? 'warning' : 'secondary';
                const statusText = progress >= 100 ? 'Terminé' : progress > 0 ? 'En cours' : 'À faire';
                
                // Vérifier si la quantité réalisée dépasse la quantité totale
                const isExcess = op.realized > op.total;
                const rowClass = isExcess ? 'operation-row-excess' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${op.name}</strong>
                            ${isExcess ? '<i class="fas fa-exclamation-triangle text-danger ms-2" title="Quantité dépassée"></i>' : ''}
                        </td>
                        <td>
                            <div class="progress-bar-custom">
                                <div class="progress-fill ${progressClass}" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${isExcess ? 'bg-danger' : 'bg-primary'}">${op.realized} / ${op.total}</span>
                        </td>
                        <td>
                            <strong>${progress}%</strong>
                        </td>
                        <td>
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </td>
                        <td class="correction-cell">
                            <span class="correction-label">Correction</span>
                            <input type="number" 
                                class="form-control form-control-sm correction-input" 
                                id="correction-${op.id}" 
                                placeholder="±">
                            <button class="btn btn-sm btn-primary" 
                                    onclick="submitCorrection(${op.id}, '${op.name.replace(/'/g, "\\'")}')">
                                Valider
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Graphiques
        function renderCharts() {
            startProgressChartAutoRefresh(); // Démarrer le graphique avec auto-refresh
            renderCostsChart(); // Graphique des coûts
        }

        // Fonction pour calculer et afficher la vraie progression dans le temps
        async function renderProgressChart() {
            const ctx = document.getElementById('progressChart');
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            try {
                // 1. Récupérer toutes les tâches du projet triées par date
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('quantity, created_at, ended_at')
                    .eq('project_id', parseInt(projectId))
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (!tasks || tasks.length === 0) {
                    // Pas de données - afficher un graphique vide
                    progressChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Aucune donnée'],
                            datasets: [{
                                label: 'Progression (%)',
                                data: [0],
                                borderColor: '#8e44ad',
                                backgroundColor: 'rgba(142, 68, 173, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    return;
                }

                // 2. Calculer le total d'unités à réaliser
                const totalToRealize = projectData.operations.reduce((sum, op) => sum + op.total, 0);
                
                if (totalToRealize === 0) {
                    console.warn('Aucune unité à réaliser configurée');
                    return;
                }

                // 3. Grouper les tâches par jour et calculer la progression cumulative
                const dailyProgress = {};
                let cumulativeRealized = 0;

                tasks.forEach(task => {
                    // Utiliser created_at ou ended_at comme date de référence
                    const taskDate = new Date(task.ended_at || task.created_at);
                    const dateKey = taskDate.toISOString().split('T')[0]; // Format YYYY-MM-DD
                    
                    if (!dailyProgress[dateKey]) {
                        dailyProgress[dateKey] = {
                            date: dateKey,
                            dailyQuantity: 0,
                            cumulativeRealized: 0,
                            progressPercent: 0
                        };
                    }
                    
                    dailyProgress[dateKey].dailyQuantity += task.quantity || 0;
                });

                // 4. Calculer la progression cumulative pour chaque jour
                const sortedDates = Object.keys(dailyProgress).sort();
                
                sortedDates.forEach(dateKey => {
                    cumulativeRealized += dailyProgress[dateKey].dailyQuantity;
                    dailyProgress[dateKey].cumulativeRealized = cumulativeRealized;
                    dailyProgress[dateKey].progressPercent = Math.round((cumulativeRealized / totalToRealize) * 100);
                });

                // 5. Préparer les données pour Chart.js
                const labels = sortedDates.map(dateKey => {
                    const date = new Date(dateKey);
                    return date.toLocaleDateString('fr-FR', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                });

                const progressData = sortedDates.map(dateKey => dailyProgress[dateKey].progressPercent);

                // 6. Créer le graphique
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Progression (%)',
                            data: progressData,
                            borderColor: '#8e44ad',
                            backgroundColor: 'rgba(142, 68, 173, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#8e44ad',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(100, Math.max(...progressData) + 10), // S'adapter si > 100%
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        const dateKey = sortedDates[index];
                                        const date = new Date(dateKey);
                                        return date.toLocaleDateString('fr-FR', { 
                                            weekday: 'long',
                                            day: 'numeric', 
                                            month: 'long',
                                            year: 'numeric'
                                        });
                                    },
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const dateKey = sortedDates[index];
                                        const dayData = dailyProgress[dateKey];
                                        
                                        return [
                                            `Progression: ${dayData.progressPercent}%`,
                                            `Unités ce jour: ${dayData.dailyQuantity}`,
                                            `Total cumulé: ${dayData.cumulativeRealized} / ${totalToRealize}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

                console.log(`📈 Graphique de progression créé avec ${sortedDates.length} points de données`);

            } catch (error) {
                console.error('Erreur création graphique progression:', error);
                
                // Fallback en cas d'erreur
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Erreur'],
                        datasets: [{
                            label: 'Progression (%)',
                            data: [0],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // Fonction pour rafraîchir le graphique toutes les 10 minutes
        function startProgressChartAutoRefresh() {
            // Rafraîchir immédiatement
            renderProgressChart();
            
            // Puis toutes les 10 minutes (600000 ms)
            setInterval(() => {
                console.log('🔄 Rafraîchissement automatique du graphique');
                renderProgressChart();
            }, 600000);
        }

        // Graphique des coûts
        function renderCostsChart() {
            const ctx = document.getElementById('costsChart');
            
            if (costsChart) {
                costsChart.destroy();
            }
            
            const costsData = {
                labels: ['Coût Opérateurs', 'Achats Externes'],
                datasets: [{
                    data: [projectData.coutOperateurs, projectData.achatsExternes],
                    backgroundColor: [
                        '#3498db',
                        '#f39c12'
                    ],
                    borderWidth: 0
                }]
            };
            
            costsChart = new Chart(ctx, {
                type: 'doughnut',
                data: costsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Historique des déclarations
        function renderDeclarationsHistory() {
            const container = document.getElementById('declarationsHistory');
            
            if (!projectData.declarations || projectData.declarations.length === 0) {
                container.innerHTML = '<p class="text-muted">Aucune déclaration trouvée</p>';
                return;
            }
            
            // Trier par date décroissante
            const sortedDeclarations = [...projectData.declarations].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedDeclarations.map((decl, index) => {
                // Calculer le taux horaire si possible
                let productivityBadge = '';
                if (decl.time && decl.quantity && decl.quantity > 0) {
                    // Extraire les minutes de la chaîne
                    const timeStr = decl.time.toLowerCase();
                    let timeInMinutes = 0;
                    
                    if (timeStr.includes('h') && timeStr.includes('min')) {
                        // Format "2h30min"
                        const hours = parseInt(timeStr.split('h')[0]) || 0;
                        const minutes = parseInt(timeStr.split('h')[1].replace('min', '')) || 0;
                        timeInMinutes = hours * 60 + minutes;
                    } else if (timeStr.includes('min')) {
                        // Format "30min"
                        timeInMinutes = parseInt(timeStr.replace('min', '')) || 0;
                    } else if (timeStr.includes('h')) {
                        // Format "2h"
                        timeInMinutes = (parseInt(timeStr.replace('h', '')) || 0) * 60;
                    }
                    
                    if (timeInMinutes > 0) {
                        const unitsPerHour = Math.round((decl.quantity / timeInMinutes) * 60);
                        productivityBadge = `
                            <span class="badge bg-secondary ms-2">
                                ${unitsPerHour} unités/h
                            </span>
                        `;
                    }
                }
                
                return `
                    <div class="history-item ${index < 3 ? 'recent' : ''}">
                        <div class="history-header">
                            <span class="history-operator">
                                <i class="fas fa-user me-2"></i>
                                ${decl.operator || 'Opérateur inconnu'}
                            </span>
                            <span class="history-time">
                                <i class="fas fa-clock me-1"></i>
                                ${formatDateTime(decl.date)}
                            </span>
                        </div>
                        <div class="history-details">
                            <strong>${decl.operation || 'Opération inconnue'}</strong> - 
                            ${decl.quantity || 0} unités en ${decl.time || 'durée inconnue'}
                            ${productivityBadge}
                        </div>
                    </div>
                `;
            }).join('');
        }
        // Fonction pour soumettre une correction
async function submitCorrection(operationId, operationName) {
    const inputField = document.getElementById(`correction-${operationId}`);
    const correctionValue = parseFloat(inputField.value);
    
    if (!correctionValue || correctionValue === 0) {
        showToast('Veuillez saisir une valeur de correction non nulle', 'warning');
        return;
    }
    
    try {
        // Vérifier/créer l'utilisateur admin si nécessaire
        let adminUser = null;
        const { data: existingAdmin, error: adminCheckError } = await supabase
            .from('users')
            .select('id')
            .eq('name', 'ADMIN_CORRECTION')
            .single();
        
        if (adminCheckError && !adminCheckError.message.includes('No rows returned')) {
            console.warn('Erreur vérification admin:', adminCheckError);
        }
        
        if (!existingAdmin) {
            // Créer l'utilisateur admin
            const { data: newAdmin, error: createAdminError } = await supabase
                .from('users')
                .insert({
                    name: 'ADMIN_CORRECTION',
                    role: 'admin',
                    created_at: new Date().toISOString()
                })
                .select()
                .single();
            
            if (createAdminError) {
                console.error('Erreur création admin:', createAdminError);
            } else {
                adminUser = newAdmin;
            }
        } else {
            adminUser = existingAdmin;
        }
        
        // Insérer la correction dans la table tasks
        const { data, error } = await supabase
            .from('tasks')
            .insert({
                project_id: parseInt(projectId),
                operation_id: operationId,
                operation_name: operationName,
                operator_name: 'ADMIN_CORRECTION',
                quantity: correctionValue,
                execution_ms: null,
                started_at: null,
                ended_at: null,
                created_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (error) throw error;
        
        showToast(`Correction de ${correctionValue > 0 ? '+' : ''}${correctionValue} appliquée`, 'success');
        
        // Rafraîchir la page après un court délai
        setTimeout(() => {
            refreshData();
        }, 500);
        
    } catch (error) {
        console.error('Erreur lors de la correction:', error);
        showToast('Erreur lors de la correction', 'error');
    }
}
        // Gestion des achats externes
        function showAddPurchaseForm() {
            document.getElementById('addPurchaseForm').style.display = 'block';
            document.getElementById('purchaseAmount').focus();
        }

        function cancelAddPurchase() {
            document.getElementById('addPurchaseForm').style.display = 'none';
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseDescription').value = '';
        }

        async function addPurchase() {
            const amount = parseFloat(document.getElementById('purchaseAmount').value);
            const description = document.getElementById('purchaseDescription').value.trim();
            
            if (!amount || amount <= 0) {
                showToast('Veuillez saisir un montant valide', 'warning');
                return;
            }
            
            if (!description) {
                showToast('Veuillez saisir une description', 'warning');
                return;
            }
            
            try {
                // Ajouter à Supabase
                const { data, error } = await supabase
                    .from('project_purchases')
                    .insert({
                        project_id: projectId,
                        amount: amount,
                        description: description,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Ajouter localement
                if (!projectData.purchases) projectData.purchases = [];
                projectData.purchases.push({
                    id: data.id,
                    amount: amount,
                    description: description,
                    date: new Date().toISOString()
                });

                // Mettre à jour l'affichage
                projectData.achatsExternes += amount;
                renderPurchases();
                renderKPISummary();
                renderRentabilityBreakdown();
                renderCostsChart();
                
                cancelAddPurchase();
                showToast('Achat externe ajouté avec succès', 'success');
                
            } catch (error) {
                console.error('Erreur ajout achat:', error);
                showToast('Erreur lors de l\'ajout de l\'achat', 'error');
            }
        }

        async function deletePurchase(purchaseId) {
            if (!confirm('Voulez-vous vraiment supprimer cet achat externe ?')) {
                return;
            }
            
            try {
                // Supprimer de Supabase
                const { error } = await supabase
                    .from('project_purchases')
                    .delete()
                    .eq('id', purchaseId);

                if (error) throw error;

                // Supprimer localement
                const purchaseIndex = projectData.purchases.findIndex(p => p.id === purchaseId);
                if (purchaseIndex !== -1) {
                    const deletedPurchase = projectData.purchases[purchaseIndex];
                    projectData.achatsExternes -= deletedPurchase.amount;
                    projectData.purchases.splice(purchaseIndex, 1);
                }

                // Mettre à jour l'affichage
                renderPurchases();
                renderKPISummary();
                renderRentabilityBreakdown();
                renderCostsChart();
                
                showToast('Achat externe supprimé', 'success');
                
            } catch (error) {
                console.error('Erreur suppression achat:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        // Navigation
        function goBack() {
            window.location.href = 'kpi-projets.html';
        }

        // Actualisation
        function refreshData() {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Actualisation...';
            
            loadProjectData().then(() => {
                // Rafraîchir aussi le graphique
                renderProgressChart();
            }).finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                showToast('Données actualisées', 'success');
            });
        }

        // Utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'Date inconnue';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Date inconnue';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR') + ' à ' + date.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-custom p-3';
            
            const borderColor = type === 'success' ? 'var(--success-color)' : 
                               type === 'warning' ? 'var(--warning-color)' : 
                               type === 'error' ? 'var(--danger-color)' : 'var(--info-color)';
            
            toast.style.borderLeftColor = borderColor;
            
            toast.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </span>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 4000);
        }

        // Gestion du clavier pour le formulaire d'achat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('addPurchaseForm').style.display === 'block') {
                e.preventDefault();
                addPurchase();
            }
            if (e.key === 'Escape' && document.getElementById('addPurchaseForm').style.display === 'block') {
                e.preventDefault();
                cancelAddPurchase();
            }
        });

        console.log('✅ KPI Projet Détail initialisé');
    </script>
</body>
</html><span class="breakdown-label">
                        <i class="fas fa-plus-circle text-success me-2"></i>
                        Prix de vente prestation
                    </span>
                    <span class="breakdown-value positive">${projectData.prixVentePrestation.toFixed(2)} €</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">
                        <i class="fas fa-minus-circle text-danger me-2"></i>
                        Coût opérateurs
                    </span>
                    <span class="breakdown-value negative">-${projectData.coutOperateurs.toFixed(2)} €</span>
                </div>

                <div class="breakdown-item">
